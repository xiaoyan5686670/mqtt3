# 继电器输入名称自定义 - 完整实现

## 功能说明

首页设备卡片右上角的"继电器输入"控件现在支持自定义名称，可以直接在文字上点击编辑。

## 使用方法

### 1. 运行迁移脚本（首次使用）

```bash
cd backend
python migrate_add_relay_in_display_name.py
```

### 2. 编辑名称

1. **鼠标悬停**在设备卡片右上角的"继电器输入"文字上
2. **点击编辑按钮**（✏️图标）
3. **输入新名称**（例如：门禁输入、报警输入等）
4. **按 Enter 保存**或点击 ✓ 按钮
5. **按 Esc 取消**或点击 ✕ 按钮

### 3. 效果

保存后，"继电器输入"文字立即更新为新名称。

## 实现原理

### 后端

#### 1. 数据库字段
在 `devices` 表中添加了 `relay_in_display_name` 字段：

```sql
ALTER TABLE devices 
ADD COLUMN relay_in_display_name VARCHAR;
```

#### 2. 数据模型
`backend/models/device.py`：
```python
relay_in_display_name = Column(String, nullable=True)  # 继电器输入的自定义显示名称
```

#### 3. API 接口
`backend/api/devices.py`：
```python
@router.put("/{device_id}/relay-in-display-name", response_model=Device)
def update_relay_in_display_name(
    device_id: int,
    update_data: RelayInDisplayNameUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_admin)
):
    """更新设备的继电器输入显示名称（仅管理员）"""
    ...
```

### 前端

#### 1. 显示逻辑
从 `device.relay_in_display_name` 字段读取名称：

```javascript
const getRelayInDisplayName = (device) => {
  if (!device) return '继电器输入'
  return (device.relay_in_display_name && device.relay_in_display_name.trim()) 
    ? device.relay_in_display_name.trim() 
    : '继电器输入'
}
```

#### 2. 编辑功能
- 鼠标悬停显示编辑按钮
- 点击进入编辑模式（显示输入框）
- 支持 Enter 保存，Esc 取消
- 调用 API 保存到数据库

#### 3. 模板结构
```vue
<div class="relay-label-wrapper">
  <!-- 查看模式 -->
  <span v-if="未编辑">
    <span class="status-label">{{ 显示名称 }}</span>
    <button class="btn-edit-relay-in">✏️</button>
  </span>
  
  <!-- 编辑模式 -->
  <div v-else>
    <input v-model="editingRelayInName" />
    <button @click="保存">✓</button>
    <button @click="取消">✕</button>
  </div>
</div>
```

## 特点

### ✅ 独立存储
- 名称存储在 `devices` 表的专用字段中
- 与传感器数据分离，不会混淆

### ✅ 直接编辑
- 直接在右上角控件上编辑
- 不需要在传感器列表中查找

### ✅ 编辑体验
- 与编辑设备名称的体验一致
- 鼠标悬停显示编辑按钮
- 支持键盘快捷键

### ✅ 持久化
- 名称保存到数据库
- 刷新页面不会丢失

### ✅ 权限控制
- 需要管理员权限才能编辑
- 普通用户只能查看

### ✅ 保持逻辑不变
- MQTT 数据处理逻辑不变
- 传感器数据存储方式不变
- 不影响其他功能

## 使用示例

### 场景 1：门禁系统
```
原名称：继电器输入
自定义名称：门禁刷卡信号
显示效果：[门禁刷卡信号] ON
```

### 场景 2：报警系统
```
原名称：继电器输入
自定义名称：红外报警
显示效果：[红外报警] OFF
```

### 场景 3：工业控制
```
原名称：继电器输入
自定义名称：紧急停止按钮
显示效果：[紧急停止按钮] ON
```

## 文件清单

### 后端
- `backend/models/device.py` - 添加 `relay_in_display_name` 字段
- `backend/schemas/device.py` - 更新 schema
- `backend/api/devices.py` - 添加 API 接口
- `backend/migrate_add_relay_in_display_name.py` - 迁移脚本

### 前端
- `frontend/src/views/Dashboard.vue` - 添加编辑功能

## 注意事项

1. **首次使用需运行迁移脚本**
2. **需要管理员权限**才能编辑名称
3. **名称长度限制**：建议 2-20 个字符
4. **设置为空**时显示默认值"继电器输入"
5. **每个设备独立**设置自己的名称

## API 接口

### 更新继电器输入名称

```
PUT /api/devices/{device_id}/relay-in-display-name
```

**请求头：**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体：**
```json
{
  "relay_in_display_name": "门禁输入"
}
```

**响应：**
```json
{
  "id": 1,
  "name": "主楼大门",
  "relay_in_display_name": "门禁输入",
  ...
}
```

## 验证

### 1. 检查数据库
```sql
SELECT id, name, relay_in_display_name 
FROM devices;
```

### 2. 检查前端
- 刷新首页
- 查看设备卡片右上角
- 应显示自定义名称

### 3. 检查编辑功能
- 鼠标悬停在名称上
- 应显示编辑按钮（✏️）
- 点击可进入编辑模式
