# 继电器自定义格式配置 - 使用指南

## 问题说明

您遇到的问题是：配置了 `{"relayoff":"off"}`，但实际发送的是 `{"relay":"off"}`。

**原因**：功能已经实现，但需要以下步骤才能生效：

## 解决步骤

### 步骤1：重启后端服务（必须）

新添加的数据库字段需要重启后端服务才能被加载。

```bash
# 停止当前运行的后端服务（按 Ctrl+C）

# 重新启动后端
cd /Users/qinxiaoyan/work/mqtt3/backend
source venv/bin/activate
python main.py
```

### 步骤2：配置设备的继电器格式

1. **访问设备列表**：
   - 打开浏览器访问：`http://192.168.1.102:5173/devices`

2. **编辑设备 stm32_4**：
   - 找到设备 stm32_4
   - 点击"编辑"按钮

3. **配置继电器消息格式**：
   - 向下滚动到"继电器控制消息格式配置"部分
   - **继电器开启消息**：输入 `{"relayoff":"on"}`（如果您要用relayoff作为key）
   - **继电器关闭消息**：输入 `{"relayoff":"off"}`
   - 点击"更新设备"保存

4. **返回仪表盘测试**：
   - 访问：`http://192.168.1.102:5173/dashboard`
   - 刷新页面（确保加载最新配置）
   - 点击设备 stm32_4 的继电器开关
   - 检查发送的消息格式

### 步骤3：验证配置

打开浏览器控制台（F12），在点击继电器开关时查看发送的请求：

```javascript
// 应该看到类似这样的请求
POST /api/mqtt-publish/publish
{
  "topic": "pc/4",
  "message": "{\"relayoff\":\"off\"}"  // 使用您配置的格式
}
```

## 当前测试配置

我已经为设备7（stm32_4）手动设置了测试配置：
- 开启消息：`{"relay":"on"}`
- 关闭消息：`{"relay":"off"}`

您可以：
1. 先测试这个配置是否工作
2. 然后在设备编辑页面修改为您需要的格式 `{"relayoff":"on"}` / `{"relayoff":"off"}`

## 配置格式说明

### 示例1：使用 relay 作为键名
```json
开启：{"relay":"on"}
关闭：{"relay":"off"}
```

### 示例2：使用 relayoff 作为键名（您的需求）
```json
开启：{"relayoff":"on"}
关闭：{"relayoff":"off"}
```

### 示例3：使用数字值
```json
开启：{"relay":1}
关闭：{"relay":0}
```

### 示例4：复杂格式
```json
开启：{"cmd":"relay","action":"on","device":"stm32_4"}
关闭：{"cmd":"relay","action":"off","device":"stm32_4"}
```

## 配置优先级

系统按以下优先级使用配置：

1. **设备级别配置**（最高优先级）
   - 在设备编辑页面配置
   - 每个设备可以有独立的格式

2. **主题级别配置**（次优先级）
   - 在主题配置页面配置
   - 多个设备共用

3. **系统默认值**（最低优先级）
   - `relayon` / `relayoff`

## 常见问题

### Q1: 配置后不生效？
**A**: 
1. 确认后端服务已重启
2. 确认配置已保存（点击了"更新设备"按钮）
3. 刷新仪表盘页面

### Q2: 如何验证配置是否保存成功？
**A**: 
1. 重新编辑该设备
2. 检查继电器配置字段是否显示您输入的内容
3. 或者通过浏览器开发工具查看 `/api/devices/7` 的返回数据

### Q3: 不同设备需要不同格式怎么办？
**A**: 
- 为每个设备单独配置即可
- 例如：
  - stm32_1 使用 `{"relay":"on"}`
  - stm32_4 使用 `{"relayoff":"on"}`
  - 其他设备留空，使用主题配置或默认值

### Q4: 可以使用字符串格式而不是JSON吗？
**A**: 
可以！示例：
- 开启消息：`relayon` 或 `1` 或 `ON`
- 关闭消息：`relayoff` 或 `0` 或 `OFF`

## 测试检查清单

- [ ] 后端服务已重启
- [ ] 在设备编辑页面输入了继电器消息格式
- [ ] 点击了"更新设备"按钮
- [ ] 返回仪表盘并刷新页面
- [ ] 点击继电器开关测试
- [ ] 检查MQTT消息格式是否正确

## 快速测试脚本

如果您想快速验证数据库中的配置，可以运行：

```bash
cd /Users/qinxiaoyan/work/mqtt3/backend
source venv/bin/activate
python -c "
from core.database import SessionLocal
from sqlalchemy import text
db = SessionLocal()
result = db.execute(text('SELECT id, name, relay_on_payload, relay_off_payload FROM devices WHERE id = 7'))
device = result.fetchone()
print(f'设备 {device[0]} ({device[1]}):')
print(f'  开启消息: {device[2]}')
print(f'  关闭消息: {device[3]}')
db.close()
"
```

## 支持

如果按照以上步骤操作后仍有问题，请检查：
1. 浏览器控制台是否有错误信息
2. 后端日志是否有错误信息
3. 数据库中的配置是否正确保存
