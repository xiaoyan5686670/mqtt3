# 继电器自定义格式配置说明

## 功能概述

本次更新实现了继电器控制消息的自定义格式配置功能。之前继电器开关的消息格式是硬编码的（`relayon`/`relayoff`），现在可以通过主题配置页面自定义为任意格式，包括字符串或JSON格式。

## 使用方法

### 1. 访问配置页面

访问主题配置页面：`http://192.168.1.102:5173/topic-config`

### 2. 配置继电器消息格式

在主题配置表单中，找到"继电器控制消息格式配置"部分：

- **继电器开启消息**：设置当点击"开启"按钮时发送的消息内容
- **继电器关闭消息**：设置当点击"关闭"按钮时发送的消息内容

### 3. 支持的格式示例

#### 字符串格式
- 简单字符串：`relayon` / `relayoff`
- 数字：`1` / `0`
- 自定义字符串：`ON` / `OFF`

#### JSON格式
- 简单JSON：`{"relay":"on"}` / `{"relay":"off"}`
- 复杂JSON：`{"cmd":"relay","value":1}` / `{"cmd":"relay","value":0}`
- 带多个参数：`{"action":"control","device":"relay","status":"on"}` / `{"action":"control","device":"relay","status":"off"}`

### 4. 默认行为

如果未配置或留空，系统将使用默认值：
- 开启：`relayon`
- 关闭：`relayoff`

## 配置示例

### 示例1：使用JSON格式

假设下位机需要接收JSON格式 `{"relay":"on"}`：

1. 打开主题配置页面
2. 编辑或创建主题配置
3. 在"继电器开启消息"中输入：`{"relay":"on"}`
4. 在"继电器关闭消息"中输入：`{"relay":"off"}`
5. 保存配置

### 示例2：使用数字格式

假设下位机需要接收数字 1/0：

1. 在"继电器开启消息"中输入：`1`
2. 在"继电器关闭消息"中输入：`0`
3. 保存配置

### 示例3：使用复杂JSON格式

假设下位机需要接收完整的命令结构：

1. 在"继电器开启消息"中输入：`{"cmd":"relay","action":"on","timestamp":""}`
2. 在"继电器关闭消息"中输入：`{"cmd":"relay","action":"off","timestamp":""}`
3. 保存配置

## 技术实现

### 后端变更

1. **数据模型** (`backend/models/topic_config.py`)
   - 添加了 `relay_on_payload` 字段
   - 添加了 `relay_off_payload` 字段

2. **数据库迁移** (`backend/migrate_add_relay_payload_fields.py`)
   - 自动添加新字段到 `topic_configs` 表

3. **API Schema** (`backend/schemas/topic_config.py`)
   - 在所有相关schema中添加了新字段支持

### 前端变更

1. **主题配置页面** (`frontend/src/views/TopicConfig.vue`)
   - 添加了继电器消息格式配置UI
   - 提供了格式示例和提示信息
   - 支持编辑和保存配置

2. **仪表盘页面** (`frontend/src/views/Dashboard.vue`)
   - 在页面加载时获取激活的主题配置
   - 在继电器开关时使用配置的消息格式
   - 如果没有配置，使用默认格式

## 工作流程

1. 用户在主题配置页面设置继电器消息格式
2. 配置保存到数据库的 `topic_configs` 表
3. 仪表盘页面启动时加载激活的主题配置
4. 用户点击继电器开关按钮时：
   - 系统读取配置的消息格式
   - 如果已配置，使用配置的格式
   - 如果未配置，使用默认格式 `relayon`/`relayoff`
   - 发送消息到MQTT主题

## 注意事项

1. **配置格式验证**：系统不会验证输入的格式是否正确，请确保输入的消息格式符合下位机的要求

2. **JSON格式**：如果使用JSON格式，请确保JSON语法正确，否则下位机可能无法解析

3. **激活配置**：只有激活的主题配置才会被使用，确保你编辑的配置是激活状态

4. **实时生效**：配置更改后，刷新仪表盘页面即可生效

## 运行迁移

首次使用此功能前，需要运行数据库迁移：

```bash
cd /Users/qinxiaoyan/work/mqtt3/backend
source venv/bin/activate
python migrate_add_relay_payload_fields.py
```

迁移成功后会显示：
```
Adding relay payload fields to topic_configs...
Added relay_on_payload field
Added relay_off_payload field
Migration completed successfully!
```

## 测试验证

1. 配置继电器消息格式
2. 保存并激活配置
3. 访问仪表盘页面
4. 点击继电器开关按钮
5. 检查MQTT消息是否按照配置的格式发送
6. 验证下位机是否正确接收并响应

## 故障排查

### 问题：点击开关没有反应
- 检查主题配置是否已激活
- 检查MQTT连接是否正常
- 检查浏览器控制台是否有错误信息

### 问题：下位机无法识别消息
- 检查配置的消息格式是否正确
- 检查JSON格式是否有语法错误
- 使用MQTT调试工具查看实际发送的消息内容

### 问题：配置保存后不生效
- 刷新仪表盘页面
- 确认编辑的是激活状态的配置
- 检查浏览器控制台是否有API调用错误

## 更新日期

2026-01-19
