# 继电器自定义格式配置说明

## 功能概述

本次更新实现了继电器控制消息的自定义格式配置功能。之前继电器开关的消息格式是硬编码的（`relayon`/`relayoff`），现在支持**两级配置**：

1. **设备级别配置**：为每个设备单独配置继电器消息格式
2. **主题级别配置**：为所有使用该主题配置的设备设置默认格式

**配置优先级**：设备配置 > 主题配置 > 系统默认值（`relayon`/`relayoff`）

## 使用方法

### 方法1：设备级别配置（推荐）

**适用场景**：不同设备使用不同的消息格式

1. **访问设备列表**：`http://192.168.1.102:5173/devices`
2. **编辑设备**：点击要配置的设备的"编辑"按钮
3. **配置继电器消息格式**：在"继电器控制消息格式配置"部分输入：
   - **继电器开启消息**：设置当点击"开启"按钮时发送的消息内容
   - **继电器关闭消息**：设置当点击"关闭"按钮时发送的消息内容
4. **保存**：点击"更新设备"保存配置

**优势**：每个设备可以有独立的配置，灵活性更高

### 方法2：主题级别配置

**适用场景**：多个设备使用相同的消息格式

1. **访问主题配置页面**：`http://192.168.1.102:5173/topic-config`
2. **编辑主题配置**：找到并编辑要使用的主题配置
3. **配置继电器消息格式**：在"继电器控制消息格式配置"部分输入格式
4. **保存并激活**：保存配置并确保该配置处于激活状态

**优势**：一次配置，多个设备共用，便于统一管理

### 3. 支持的格式示例

#### 字符串格式
- 简单字符串：`relayon` / `relayoff`
- 数字：`1` / `0`
- 自定义字符串：`ON` / `OFF`

#### JSON格式
- 简单JSON：`{"relay":"on"}` / `{"relay":"off"}`
- 复杂JSON：`{"cmd":"relay","value":1}` / `{"cmd":"relay","value":0}`
- 带多个参数：`{"action":"control","device":"relay","status":"on"}` / `{"action":"control","device":"relay","status":"off"}`

### 4. 配置优先级

系统按以下优先级查找配置：

1. **设备级别配置**：如果该设备设置了继电器消息格式，优先使用
2. **主题级别配置**：如果设备未配置，但激活的主题配置中有设置，则使用主题配置
3. **系统默认值**：如果以上都未配置，使用系统默认值 `relayon`/`relayoff`

### 5. 留空行为

- 设备配置留空：使用主题配置或默认值
- 主题配置留空：使用默认值
- 全部留空：使用默认值 `relayon`/`relayoff`

## 配置示例

### 示例1：单个设备使用JSON格式

假设设备ID为1的下位机需要接收JSON格式 `{"relay":"on"}`：

1. 打开设备列表：`http://192.168.1.102:5173/devices`
2. 找到设备ID为1的设备，点击"编辑"
3. 在"继电器开启消息"中输入：`{"relay":"on"}`
4. 在"继电器关闭消息"中输入：`{"relay":"off"}`
5. 点击"更新设备"保存

### 示例2：所有设备使用统一格式

假设所有设备都需要接收数字 1/0：

1. 打开主题配置页面
2. 编辑激活的主题配置
3. 在"继电器开启消息"中输入：`1`
4. 在"继电器关闭消息"中输入：`0`
5. 保存配置

### 示例3：混合使用（部分设备特殊配置）

场景：大部分设备使用字符串格式，个别设备需要JSON格式

1. **配置主题默认格式**（通用格式）：
   - 打开主题配置页面
   - 继电器开启消息：`relayon`
   - 继电器关闭消息：`relayoff`
   - 保存

2. **为特殊设备配置**（设备ID为5需要JSON格式）：
   - 打开设备列表，编辑设备5
   - 继电器开启消息：`{"relay":"on"}`
   - 继电器关闭消息：`{"relay":"off"}`
   - 保存

**结果**：设备5使用JSON格式，其他设备使用字符串格式

### 示例4：使用复杂JSON格式

假设某个设备的下位机需要接收完整的命令结构：

1. 编辑该设备
2. 在"继电器开启消息"中输入：`{"cmd":"relay","action":"on","device_id":"1"}`
3. 在"继电器关闭消息"中输入：`{"cmd":"relay","action":"off","device_id":"1"}`
4. 保存

## 技术实现

### 后端变更

1. **设备数据模型** (`backend/models/device.py`)
   - 添加了 `relay_on_payload` 字段（设备级别）
   - 添加了 `relay_off_payload` 字段（设备级别）

2. **主题配置数据模型** (`backend/models/topic_config.py`)
   - 添加了 `relay_on_payload` 字段（主题级别）
   - 添加了 `relay_off_payload` 字段（主题级别）

3. **数据库迁移**
   - `backend/migrate_add_relay_payload_fields.py` - 为 `topic_configs` 表添加新字段
   - `backend/migrate_add_device_relay_payload_fields.py` - 为 `devices` 表添加新字段

4. **API Schema**
   - `backend/schemas/device.py` - 在所有设备schema中添加了新字段
   - `backend/schemas/topic_config.py` - 在所有主题配置schema中添加了新字段

### 前端变更

1. **设备编辑页面** (`frontend/src/views/DeviceEdit.vue`)
   - 添加了继电器消息格式配置UI（设备级别）
   - 提供了格式示例和优先级说明
   - 支持编辑和保存单个设备的配置

2. **主题配置页面** (`frontend/src/views/TopicConfig.vue`)
   - 添加了继电器消息格式配置UI（主题级别）
   - 提供了格式示例和提示信息
   - 支持编辑和保存通用配置

3. **仪表盘页面** (`frontend/src/views/Dashboard.vue`)
   - 在页面加载时获取激活的主题配置
   - 在继电器开关时按优先级使用配置的消息格式
   - 优先级：设备配置 > 主题配置 > 默认值

## 工作流程

### 配置流程

1. **设备级别配置**（可选）：
   - 用户在设备编辑页面设置该设备的继电器消息格式
   - 配置保存到数据库的 `devices` 表

2. **主题级别配置**（可选）：
   - 用户在主题配置页面设置通用的继电器消息格式
   - 配置保存到数据库的 `topic_configs` 表

### 运行流程

1. 仪表盘页面启动时：
   - 加载所有设备信息（包含设备级别的继电器配置）
   - 加载激活的主题配置（包含主题级别的继电器配置）

2. 用户点击继电器开关按钮时：
   - 系统按优先级查找配置：
     1. 首先检查设备级别配置
     2. 如果设备未配置，检查主题级别配置
     3. 如果都未配置，使用默认值 `relayon`/`relayoff`
   - 使用找到的格式发送消息到MQTT主题

## 注意事项

1. **配置格式验证**：系统不会验证输入的格式是否正确，请确保输入的消息格式符合下位机的要求

2. **JSON格式**：如果使用JSON格式，请确保JSON语法正确，否则下位机可能无法解析

3. **配置优先级**：
   - 设备级别配置优先于主题级别配置
   - 如果设备有配置，即使主题也有配置，也会使用设备的配置
   - 只有设备未配置时，才会使用主题配置

4. **激活配置**：只有激活的主题配置才会被使用（设备级别配置不需要激活）

5. **实时生效**：
   - 设备配置更改后，刷新仪表盘页面即可生效
   - 主题配置更改后，刷新仪表盘页面即可生效

6. **配置管理建议**：
   - 如果所有设备格式相同，建议使用主题配置
   - 如果个别设备格式特殊，建议主题配置 + 设备配置组合使用
   - 避免重复配置，优先使用通用的主题配置

## 运行迁移

首次使用此功能前，需要运行数据库迁移（两个脚本）：

### 1. 迁移主题配置表

```bash
cd /Users/qinxiaoyan/work/mqtt3/backend
source venv/bin/activate
python migrate_add_relay_payload_fields.py
```

迁移成功后会显示：
```
Adding relay payload fields to topic_configs...
Added relay_on_payload field
Added relay_off_payload field
Migration completed successfully!
```

### 2. 迁移设备表

```bash
python migrate_add_device_relay_payload_fields.py
```

迁移成功后会显示：
```
Adding relay payload fields to devices...
Added relay_on_payload field
Added relay_off_payload field
Migration completed successfully!
```

## 测试验证

### 测试场景1：测试设备级别配置

1. 编辑一个设备，配置继电器消息格式
2. 保存设备
3. 访问仪表盘页面
4. 点击该设备的继电器开关按钮
5. 检查MQTT消息是否按照设备配置的格式发送
6. 验证下位机是否正确接收并响应

### 测试场景2：测试主题级别配置

1. 编辑主题配置，配置继电器消息格式
2. 保存并激活配置
3. 确保测试设备未配置设备级别的继电器格式（留空）
4. 访问仪表盘页面
5. 点击继电器开关按钮
6. 检查MQTT消息是否按照主题配置的格式发送
7. 验证下位机是否正确接收并响应

### 测试场景3：测试优先级

1. 同时配置主题级别和设备级别的继电器格式（使用不同的格式）
2. 访问仪表盘页面
3. 点击继电器开关按钮
4. 验证使用的是设备级别配置（优先级更高）

### 测试场景4：测试默认值

1. 清空设备和主题的继电器配置
2. 访问仪表盘页面
3. 点击继电器开关按钮
4. 验证使用的是默认值 `relayon`/`relayoff`

## 故障排查

### 问题：点击开关没有反应
- 检查主题配置是否已激活
- 检查MQTT连接是否正常
- 检查浏览器控制台是否有错误信息

### 问题：下位机无法识别消息
- 检查配置的消息格式是否正确
- 检查JSON格式是否有语法错误
- 使用MQTT调试工具查看实际发送的消息内容

### 问题：配置保存后不生效
- 刷新仪表盘页面
- 检查配置优先级（设备配置会覆盖主题配置）
- 确认主题配置是激活状态（如果使用主题配置）
- 检查浏览器控制台是否有API调用错误

### 问题：设备配置没有生效，使用了主题配置
- 确认设备配置已正确保存
- 检查设备配置是否留空（留空会使用主题配置）
- 刷新仪表盘页面重新加载数据

## 功能演进

### 版本1（初始版本）
- 继电器消息格式硬编码为 `relayon`/`relayoff`

### 版本2（主题级别配置）
- 支持在主题配置中自定义继电器消息格式
- 所有使用该主题的设备共用相同格式

### 版本3（设备级别配置 - 当前版本）
- 新增设备级别的继电器消息格式配置
- 每个设备可以有独立的配置
- 实现配置优先级：设备配置 > 主题配置 > 默认值
- 灵活性更高，满足不同设备使用不同格式的需求

## 更新日期

2026-01-19

## 更新记录

- 2026-01-19：添加设备级别配置，实现独立配置功能
- 2026-01-19：初始版本，添加主题级别配置
