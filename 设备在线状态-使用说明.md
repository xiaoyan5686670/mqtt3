# 设备在线/离线状态功能 - 使用说明

## 📋 功能概述

在 Dashboard 首页显示设备的实时在线/离线状态，包括：
- ✅ 统计卡片（总设备数、在线设备数、离线设备数）
- ✅ 状态指示器（绿色/红色圆点）
- ✅ 自动刷新（每5秒）

## 🔧 配置信息

**已完成配置：**
- EMQX 服务器：172.16.208.176
- API 端口：18083
- API Key：f3d064c3dacad617
- 数据库：已迁移并配置完成

## 🚀 启动系统

### 方法1: 使用启动脚本（推荐）

```bash
# 启动后端
./start_backend.sh

# 新终端启动前端
./start_frontend.sh
```

### 方法2: 手动启动

**后端：**
```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt  # 首次运行
python main.py
```

**前端：**
```bash
cd frontend
npm install  # 首次运行
npm run dev
```

**访问：** http://localhost:5173

## 🎯 查看效果

### 1. Dashboard 首页

登录后自动进入 Dashboard，应该看到：

**顶部统计卡片（横向排列）：**
- 📊 **总设备数**（紫色卡片）- 显示所有设备总数
- ✅ **在线设备**（绿色卡片）- 显示当前在线的设备数
- ❌ **离线设备**（红色卡片）- 显示离线的设备数

**设备卡片：**
- 左上角有圆形状态指示器
- 🟢 绿色圆点 = 在线（会闪烁）
- 🔴 红色圆点 = 离线

### 2. EMQX API 配置页面

点击导航菜单"EMQX API配置"，可以：
- 查看当前配置
- 测试 API 连接
- 修改 API Key
- 查看连接状态

## 🧪 验证功能

### 快速验证

```bash
# 1. 连接一个测试设备
mosquitto_pub -h 172.16.208.176 -p 1883 \
  -i test_device_999 \
  -t "test/status" \
  -m "online" \
  -d

# 2. 在 Dashboard 中观察：
#    - 在线设备数 +1
#    - 如果系统中有该设备，显示绿色圆点

# 3. 断开设备（Ctrl+C）

# 4. 等待5秒后观察：
#    - 在线设备数 -1
#    - 设备变为红色圆点
```

### 手动测试 EMQX API

```bash
# 使用 curl 测试
curl -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients \
  | python -m json.tool

# 应该返回客户端列表
```

## ⚠️ 注意事项

### 设备 ID 匹配

确保 MQTT 客户端的 ClientID 与系统中的设备匹配：

**系统设备：**
- ID: `1` 或
- Name: `device_001`

**MQTT ClientID 应该是：**
- `1` 或
- `device_001`

### 刷新延迟

- 状态更新有最多 5 秒延迟
- 这是正常的自动刷新间隔
- 可手动刷新页面（F5）立即更新

## 🐛 故障排查

### 问题：所有设备显示离线

**快速检查：**
```bash
# 1. EMQX 服务是否运行
curl http://172.16.208.176:18083

# 2. API Key 是否正确
# 在"EMQX API配置"页面点击"测试连接"

# 3. 查看后端日志
tail -20 backend/logs/app.log
```

### 问题：统计数字不更新

**解决方案：**
1. 刷新浏览器页面（F5）
2. 检查浏览器控制台是否有错误
3. 检查后端日志

### 问题：测试连接失败

**检查清单：**
- [ ] EMQX 服务运行在 172.16.208.176:18083
- [ ] API Key 正确：f3d064c3dacad617
- [ ] Secret Key 正确（已保存）
- [ ] 网络连接正常
- [ ] 防火墙允许访问端口 18083

## 📚 完整文档

更多详细信息请查看：

| 文档 | 用途 |
|------|------|
| [启动验证指南](./启动验证指南.md) | 首次启动必读 |
| [快速启动](./QUICKSTART_ONLINE_STATUS.md) | 5分钟快速体验 |
| [完整指南](./设备在线状态功能-完整指南.md) | 全面的功能说明 |
| [技术文档](./DEVICE_ONLINE_STATUS_FEATURE.md) | 技术实现细节 |
| [功能总结](./功能实现总结.md) | 开发工作总结 |

## ✨ 快速命令参考

```bash
# 启动后端
cd backend && source venv/bin/activate && python main.py

# 启动前端（新终端）
cd frontend && npm run dev

# 测试 EMQX API
cd backend && source venv/bin/activate && python test_emqx_api.py

# 查看后端日志
tail -f backend/logs/app.log

# 测试 API 连接
curl -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients

# 访问系统
open http://localhost:5173
```

---

**准备好了？立即启动系统体验新功能！** 🎉
