# 设备在线/离线状态功能 - 启动验证指南

## ✅ 配置完成确认

已完成的工作：
- ✅ 数据库迁移成功（添加了 api_port、api_key、api_secret 字段）
- ✅ API Key 已配置（f3d064c3dacad617）
- ✅ 前端页面已创建（EmqxApiConfig.vue）
- ✅ 后端 API 已实现（emqx_api_config.py）
- ✅ 导航菜单已添加
- ✅ Dashboard 页面已更新

## 🚀 启动步骤

### 步骤1: 确保依赖已安装

```bash
cd backend
source venv/bin/activate

# 如果 requests 包未安装，手动安装：
pip install requests==2.31.0

# 验证安装
python -c "import requests; print('requests installed:', requests.__version__)"
```

### 步骤2: 启动后端服务

```bash
# 在 backend 目录，虚拟环境已激活的状态下
python main.py
```

**期望输出：**
```
INFO: 启动应用: MQTT IoT管理系统 v1.0.0
INFO: API前缀: /api/v1
INFO: MQTT客户端初始化成功，连接到 172.16.208.176:1883
INFO: MQTT连接成功，开始订阅主题...
INFO: MQTT服务启动成功
INFO: Uvicorn running on http://0.0.0.0:8000
```

### 步骤3: 启动前端服务

打开新终端：

```bash
cd frontend
npm run dev
```

**期望输出：**
```
  VITE v4.x.x  ready in xxx ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

### 步骤4: 访问系统

1. 打开浏览器访问: http://localhost:5173
2. 使用管理员账号登录

## ✨ 验证功能

### 验证1: 查看 Dashboard 首页

**应该看到：**

1. ⬜ **顶部统计卡片**（3个卡片横排显示）
   - 📊 总设备数（紫色卡片）
   - ✅ 在线设备（绿色卡片）
   - ❌ 离线设备（红色卡片）

2. ⬜ **设备卡片状态指示器**
   - 每个设备卡片左上角有圆形状态指示器
   - 在线设备：绿色圆点，会脉冲闪烁
   - 离线设备：红色圆点，静止

3. ⬜ **自动刷新**
   - 观察 5 秒，统计数字会自动更新

### 验证2: 检查 EMQX API 配置页面

**步骤：**
1. 点击导航栏的"EMQX API配置"菜单
2. 应该看到已配置的信息：
   - API 端口: 18083
   - API Key: f3d064c3dacad617
   - Secret Key: ••••••••

3. 点击"测试连接"按钮
4. 应该显示：
   - ✅ 连接成功
   - 显示当前客户端数量

### 验证3: 查看浏览器控制台

按 F12 打开开发者工具，查看控制台：

**应该看到（每5秒一次）：**
```
正在调用 /api/mqtt-publish/clients
成功获取客户端状态
```

**不应该看到：**
- ❌ 401 Unauthorized 错误
- ❌ 网络连接错误
- ❌ CORS 错误

### 验证4: 查看后端日志

```bash
tail -f backend/logs/app.log
```

**应该看到（每5秒一次）：**
```
INFO: 正在调用 EMQX API: http://172.16.208.176:18083/api/v5/clients
INFO: ✅ 成功获取 EMQX 客户端列表，共 X 个客户端
```

**不应该看到：**
- ❌ EMQX API 认证失败
- ❌ 无法连接到 EMQX API

## 🧪 功能测试

### 测试1: 设备上线测试

```bash
# 启动一个 MQTT 测试客户端
mosquitto_pub -h 172.16.208.176 -p 1883 \
  -i test_device_001 \
  -t "test/topic" \
  -m "hello" \
  -d

# 保持连接不断开 (-d 参数会持续运行)
```

**期望结果：**
- 等待最多 5 秒
- Dashboard 中应该看到在线设备数量 +1
- 如果系统中有名为 `test_device_001` 的设备，该设备应该显示绿色圆点

### 测试2: 设备离线测试

```bash
# 断开上面的 MQTT 客户端（按 Ctrl+C）
```

**期望结果：**
- 等待最多 5 秒
- Dashboard 中应该看到在线设备数量 -1
- 设备应该显示红色圆点

### 测试3: 批量设备测试

创建测试脚本 `test_multiple_clients.sh`:

```bash
#!/bin/bash
# 模拟多个设备连接

for i in {1..5}; do
  mosquitto_pub -h 172.16.208.176 -p 1883 \
    -i "test_device_$i" \
    -t "test/topic$i" \
    -m "device $i online" &
done

echo "5 devices connected"
echo "Press Ctrl+C to disconnect all"
wait
```

运行：
```bash
chmod +x test_multiple_clients.sh
./test_multiple_clients.sh
```

## 🐛 故障排查清单

### 检查项1: EMQX 服务状态

```bash
# 测试 EMQX 是否运行
curl http://172.16.208.176:18083

# 应该返回 EMQX Dashboard 页面或 API 响应
```

### 检查项2: API Key 是否正确

```bash
# 手动测试 API 调用
curl -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients \
  | jq .

# 应该返回客户端列表的 JSON 数据
```

### 检查项3: 后端日志

```bash
# 查看最近的日志
tail -50 backend/logs/app.log

# 搜索错误
grep "ERROR" backend/logs/app.log | tail -20

# 搜索 EMQX 相关日志
grep "EMQX" backend/logs/app.log | tail -20
```

### 检查项4: 数据库配置

```bash
# 查看数据库中的 API Key 配置
cd backend
source venv/bin/activate
python -c "
from core.database import SessionLocal
from sqlalchemy import text

db = SessionLocal()
result = db.execute(text('SELECT name, server, api_port, api_key FROM mqtt_configs WHERE is_active = 1'))
config = result.fetchone()
if config:
    print(f'Active Config: {config[0]}')
    print(f'Server: {config[1]}')
    print(f'API Port: {config[2]}')
    print(f'API Key: {config[3]}')
else:
    print('No active config found!')
db.close()
"
```

## 📸 预期效果截图描述

### Dashboard 首页

```
┌──────────────────────────────────────────────────┐
│  [Logo]  设备仪表板                              │
│          MQTT IoT 管理系统                       │
└──────────────────────────────────────────────────┘

┌───────────────┬───────────────┬───────────────┐
│ 📊 总设备数   │ ✅ 在线设备   │ ❌ 离线设备   │
│     10       │      7       │      3       │
└───────────────┴───────────────┴───────────────┘

┌─ 搜索框 ──────────────────────────────────────┐
│ 🔍 搜索设备名称、位置或类型...                │
└───────────────────────────────────────────────┘

┌─────────┬─────────┬─────────┬─────────┐
│ ⚫ 设备A │ ⚫ 设备B │ ⚫ 设备C │ ⚫ 设备D │
│ 温度:25 │ 温度:26 │ 温度:-- │ 温度:-- │
│ 湿度:60 │ 湿度:65 │ 湿度:-- │ 湿度:-- │
│ [详情]  │ [详情]  │ [详情]  │ [详情]  │
└─────────┴─────────┴─────────┴─────────┘
  (在线)    (在线)    (离线)    (离线)
```

### EMQX API 配置页面

```
EMQX API 配置
配置 EMQX REST API 访问密钥，用于获取客户端连接状态等信息

┌─────────────────────────────────────┐
│  API 密钥配置                       │
├─────────────────────────────────────┤
│                                     │
│  API 端口: [18083]                  │
│  EMQX 管理 API 端口，默认为 18083    │
│                                     │
│  API Key: [f3d064c3dacad617]        │
│  在 EMQX Dashboard 的"系统设置 ->    │
│  API 密钥"中创建                     │
│                                     │
│  Secret Key: [••••••••••••••]      │
│  创建 API Key 时生成的密钥           │
│                                     │
│  ℹ️ 如何获取 API Key？               │
│  1. 访问 EMQX Dashboard              │
│  2. 进入"系统设置" -> "API 密钥"     │
│  3. 点击"创建"按钮                   │
│  4. 复制生成的密钥                   │
│                                     │
│         [测试连接]  [保存配置]       │
└─────────────────────────────────────┘
```

## 🎯 关键检查点

启动后，请依次检查以下项目：

- [ ] 后端服务正常启动（端口 8000）
- [ ] 前端服务正常启动（端口 5173）
- [ ] 能够成功登录系统
- [ ] Dashboard 首页显示统计卡片
- [ ] 统计卡片显示正确的数字
- [ ] 设备卡片显示状态指示器（绿色或红色圆点）
- [ ] 在线设备的圆点有脉冲动画效果
- [ ] 5秒后自动刷新，数字可能会变化
- [ ] 点击"EMQX API配置"菜单能正常打开
- [ ] 配置页面显示已保存的 API Key
- [ ] 点击"测试连接"显示成功并显示客户端数量
- [ ] 浏览器控制台没有错误信息
- [ ] 后端日志没有错误信息

## 📞 遇到问题？

### 快速诊断命令

```bash
# 1. 检查后端是否运行
curl http://localhost:8000/health

# 2. 检查前端是否运行
curl http://localhost:5173

# 3. 测试 EMQX API（需要先安装 requests 包）
cd backend
source venv/bin/activate
python test_emqx_api.py

# 4. 查看数据库配置
sqlite3 ../mqtt_iot.db "SELECT name, server, api_port, api_key FROM mqtt_configs WHERE is_active = 1;"
```

### 常见错误及解决

**错误1: ModuleNotFoundError: No module named 'requests'**

```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

**错误2: 所有设备显示离线**

检查：
1. EMQX 服务是否运行在 172.16.208.176:18083
2. API Key 是否正确配置
3. 设备 ClientID 是否与系统中的设备 ID/名称匹配

**错误3: 401 Unauthorized**

说明 API Key 认证失败：
1. 在前端"EMQX API配置"页面重新输入 API Key
2. 点击"测试连接"
3. 如果测试失败，请在 EMQX Dashboard 中重新生成 API Key

## 🎉 成功标志

如果看到以下现象，说明功能正常：

1. ✅ Dashboard 顶部显示三个统计卡片
2. ✅ 统计数字会根据实际情况显示
3. ✅ 设备卡片左上角有彩色圆点
4. ✅ 在线设备的绿色圆点会脉冲闪烁
5. ✅ 每5秒统计数字会刷新
6. ✅ EMQX API 配置页面测试连接成功
7. ✅ 后端日志显示成功获取客户端列表
8. ✅ 浏览器控制台无错误

## 📝 下一步

功能验证成功后，您可以：

1. **查看实时效果**
   - 让几个 MQTT 设备连接/断开
   - 观察 Dashboard 统计数字的变化
   - 观察设备状态指示器的变化

2. **自定义配置**
   - 在"EMQX API配置"页面修改 API Key
   - 调整自动刷新间隔（修改 Dashboard.vue）

3. **监控和维护**
   - 定期查看后端日志
   - 监控 EMQX API 调用次数
   - 必要时更新 API Key

4. **扩展功能**
   - 添加设备上线/下线历史记录
   - 添加告警通知功能
   - 优化性能和缓存

## 🔗 相关文档

- [完整功能指南](./设备在线状态功能-完整指南.md)
- [快速启动](./QUICKSTART_ONLINE_STATUS.md)
- [技术文档](./DEVICE_ONLINE_STATUS_FEATURE.md)
- [EMQX API 配置](./EMQX_API_CONFIG.md)
- [修改清单](./CHANGES.md)

---

**准备好了吗？** 现在就启动系统看看效果吧！🚀
