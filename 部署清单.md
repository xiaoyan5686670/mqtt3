# 设备在线/离线状态功能 - 部署清单

## ✅ 已完成的准备工作

- ✅ 数据库已迁移（添加 EMQX API 字段）
- ✅ API Key 已配置到数据库
- ✅ 所有代码文件已创建/修改
- ✅ 依赖包已更新

## 📋 部署步骤清单

### 步骤1: 安装依赖 ⏱️ 2分钟

```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

**验证：**
```bash
python -c "import requests; print('OK')"
```
应该输出：`OK`

---

### 步骤2: 验证数据库迁移 ⏱️ 1分钟

```bash
# 检查数据库中的 API Key 配置
cd backend
source venv/bin/activate
python -c "
from core.database import SessionLocal
from sqlalchemy import text
db = SessionLocal()
result = db.execute(text('SELECT name, api_key FROM mqtt_configs WHERE is_active = 1'))
config = result.fetchone()
print('Active Config:', config[0] if config else 'None')
print('API Key:', config[1] if config else 'Not Set')
db.close()
"
```

**期望输出：**
```
Active Config: test2
API Key: f3d064c3dacad617
```

---

### 步骤3: 测试 EMQX API 连接 ⏱️ 1分钟

```bash
# 手动测试 API
curl -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients
```

**期望结果：**
- 返回 JSON 格式的客户端列表
- 不应该出现 401 Unauthorized 错误

---

### 步骤4: 启动后端服务 ⏱️ 1分钟

```bash
cd backend
source venv/bin/activate
python main.py
```

**验证日志应该包含：**
```
✅ INFO: 启动应用: MQTT IoT管理系统 v1.0.0
✅ INFO: MQTT服务启动成功
✅ INFO: Uvicorn running on http://0.0.0.0:8000
```

**不应该有：**
```
❌ ERROR: 无法连接到 EMQX API
❌ ERROR: EMQX API 认证失败
```

---

### 步骤5: 启动前端服务 ⏱️ 1分钟

**打开新终端：**
```bash
cd frontend
npm run dev
```

**验证输出应该包含：**
```
✅ VITE ready in xxx ms
✅ Local: http://localhost:5173/
```

---

### 步骤6: 访问并验证 ⏱️ 3分钟

**1. 打开浏览器：**
```
http://localhost:5173
```

**2. 登录系统**（使用管理员账号）

**3. 检查 Dashboard 首页：**
- [ ] 看到3个统计卡片（总设备数、在线设备、离线设备）
- [ ] 统计数字正确显示
- [ ] 每个设备卡片有状态圆点
- [ ] 在线设备圆点是绿色并闪烁
- [ ] 离线设备圆点是红色

**4. 检查 EMQX API 配置页面：**
- [ ] 点击导航栏"EMQX API配置"
- [ ] 看到配置信息：
  - API 端口：18083
  - API Key：f3d064c3dacad617
  - Secret Key：显示为 ••••
- [ ] 点击"测试连接"
- [ ] 显示"连接成功！当前有 X 个客户端在线"

**5. 检查自动刷新：**
- [ ] 等待 5 秒
- [ ] 观察统计数字（可能会变化）
- [ ] 观察浏览器控制台无错误

---

### 步骤7: 功能测试 ⏱️ 2分钟

```bash
# 测试设备上线
mosquitto_pub -h 172.16.208.176 -p 1883 \
  -i test_device_999 \
  -t "test/topic" \
  -m "online test" \
  -d
```

**观察 Dashboard：**
- 等待最多 5 秒
- 在线设备数应该 +1

**断开设备：**
- 按 Ctrl+C
- 等待最多 5 秒
- 在线设备数应该 -1

---

## ✅ 部署完成检查表

### 后端检查
- [ ] 依赖包已安装（requests）
- [ ] 数据库迁移成功
- [ ] API Key 已配置
- [ ] 后端服务启动成功
- [ ] 日志无错误信息
- [ ] API 端点可访问（/api/mqtt-publish/clients）

### 前端检查
- [ ] npm 依赖已安装
- [ ] 前端服务启动成功
- [ ] 页面可正常访问
- [ ] 路由配置正确
- [ ] 导航菜单显示"EMQX API配置"

### 功能检查
- [ ] Dashboard 显示统计卡片
- [ ] 统计数字正确
- [ ] 设备显示状态圆点
- [ ] 在线设备圆点闪烁
- [ ] 离线设备圆点静止
- [ ] 自动刷新正常（5秒）
- [ ] EMQX API 配置页面正常
- [ ] 测试连接功能正常

### 性能检查
- [ ] 页面响应速度正常（< 2秒）
- [ ] API 调用成功率 > 95%
- [ ] 无内存泄漏
- [ ] 浏览器性能正常

---

## 🐛 故障排查命令

### 一键检查脚本

创建 `check_status.sh`:

```bash
#!/bin/bash
echo "=== Checking EMQX Online Status Feature ==="
echo ""

echo "1. Checking backend service..."
curl -s http://localhost:8000/health && echo "✅ Backend OK" || echo "❌ Backend Failed"

echo ""
echo "2. Checking frontend service..."
curl -s http://localhost:5173 > /dev/null && echo "✅ Frontend OK" || echo "❌ Frontend Failed"

echo ""
echo "3. Checking EMQX API..."
curl -s -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients > /dev/null && \
  echo "✅ EMQX API OK" || echo "❌ EMQX API Failed"

echo ""
echo "4. Checking database config..."
cd backend
source venv/bin/activate
python -c "
from core.database import SessionLocal
from sqlalchemy import text
db = SessionLocal()
result = db.execute(text('SELECT COUNT(*) FROM mqtt_configs WHERE api_key IS NOT NULL'))
count = result.fetchone()[0]
print('✅ API Key Configured' if count > 0 else '❌ API Key Not Configured')
db.close()
"

echo ""
echo "=== Check Complete ==="
```

运行：
```bash
chmod +x check_status.sh
./check_status.sh
```

---

## 📊 部署时间估算

| 步骤 | 时间 | 说明 |
|------|------|------|
| 安装依赖 | 2分钟 | pip install |
| 验证迁移 | 1分钟 | 检查数据库 |
| 测试API | 1分钟 | curl测试 |
| 启动后端 | 1分钟 | python main.py |
| 启动前端 | 1分钟 | npm run dev |
| 验证功能 | 3分钟 | 功能测试 |
| 功能测试 | 2分钟 | 设备上下线测试 |
| **总计** | **11分钟** | 完整部署 |

## 🎯 成功标准

部署成功的标志：

### 必须满足（Critical）
1. ✅ 后端服务正常运行
2. ✅ 前端服务正常运行
3. ✅ Dashboard 显示统计卡片
4. ✅ 设备显示状态圆点

### 应该满足（Important）
5. ✅ 统计数字准确
6. ✅ 在线设备圆点闪烁
7. ✅ 自动刷新正常
8. ✅ EMQX API 配置页面可用

### 可以满足（Nice to have）
9. ✅ 测试连接成功
10. ✅ 实时设备测试通过
11. ✅ 日志无错误
12. ✅ 性能表现良好

## 🔄 回滚方案

如果部署出现问题，可以回滚：

### 回滚步骤

**1. 前端回滚：**
```bash
git checkout frontend/src/views/Dashboard.vue
git checkout frontend/src/App.vue
git checkout frontend/src/router/index.js
rm frontend/src/views/EmqxApiConfig.vue
```

**2. 后端回滚：**
```bash
git checkout backend/services/mqtt_service.py
git checkout backend/api/mqtt_publish.py
git checkout backend/api/__init__.py
git checkout backend/models/mqtt_config.py
git checkout backend/schemas/mqtt_config.py
rm backend/api/emqx_api_config.py
```

**3. 重启服务**

---

## 📞 遇到问题？

### 错误1: 模块找不到

```bash
# 解决方案
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

### 错误2: 所有设备显示离线

**检查清单：**
1. EMQX 服务是否运行
2. API Key 是否正确
3. 网络是否连通
4. 设备 ClientID 是否匹配

**快速测试：**
```bash
curl -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients
```

### 错误3: 页面无响应

**解决方案：**
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 硬刷新页面（Ctrl+Shift+R）
3. 检查浏览器控制台错误

---

## 📚 完整文档链接

| 文档 | 用途 | 优先级 |
|------|------|--------|
| [README_设备在线状态功能](./README_设备在线状态功能.md) | 功能概览 | ⭐⭐⭐ |
| [设备在线状态-使用说明](./设备在线状态-使用说明.md) | 使用指南 | ⭐⭐⭐ |
| [启动验证指南](./启动验证指南.md) | 启动验证 | ⭐⭐⭐ |
| [功能实现总结](./功能实现总结.md) | 实现总结 | ⭐⭐ |

---

## 🎉 部署完成后

恭喜您完成部署！现在您可以：

1. **使用功能**
   - 实时查看设备在线状态
   - 监控设备连接情况
   - 统计在线/离线设备

2. **管理配置**
   - 在"EMQX API配置"页面管理密钥
   - 定期测试连接
   - 必要时更新 API Key

3. **监控运行**
   - 查看后端日志
   - 监控 API 调用
   - 关注性能指标

## 🚀 立即启动

```bash
# 后端
cd backend && source venv/bin/activate && python main.py

# 前端（新终端）
cd frontend && npm run dev

# 浏览器
open http://localhost:5173
```

---

**准备好了吗？开始享受新功能吧！** 🎊
