# 继电器输入控件修复说明

## 问题概述

首页上的"继电器输入"（`realy_in_status` / `relay_in_status`）控件存在以下缺陷：

### 问题 1：重复显示
- **现象**：继电器输入在设备卡片上显示了两次
  1. 卡片头部右侧的专门状态指示器
  2. 下方的"其他传感器"列表中
- **原因**：`isPrioritySensor` 函数只过滤温度和湿度传感器，没有排除继电器输入类型

### 问题 2：拼写不一致
- **现象**：前端只查找 `realy_in_status`（错误拼写），导致正确拼写 `relay_in_status` 的数据无法显示
- **原因**：历史遗留问题，系统中存在两种拼写

### 问题 3：控制按钮显示错误
- **现象**：继电器输入是只读字段（显示外部输入状态），但在传感器列表中显示了开启/关闭控制按钮
- **原因**：`isRelayType` 函数将所有继电器类型都视为可控制的

## 修复方案

### 前端修复 (`frontend/src/views/Dashboard.vue`)

#### 1. 新增 `isReadOnlyRelayInput` 函数
```javascript
// 判断是否为只读的继电器输入类型（不应该在列表中显示控制按钮）
const isReadOnlyRelayInput = (type) => {
  if (!type) return false
  const t = type.toLowerCase()
  return t === 'realy_in_status' || t === 'relay_in_status'
}
```

#### 2. 修改 `getOtherSensors` 函数
```javascript
// 排除继电器输入，避免重复显示
const getOtherSensors = (sensors) => 
  sensors.filter(s => !isPrioritySensor(s.type) && !isReadOnlyRelayInput(s.type))
```

#### 3. 修改 `getRelayInStatusValue` 函数（只取实时数据）
```javascript
// 只取 realy_in_status（实时上报，时效性高），不取 relay_in_status（10秒上报，时效性低）
const getRelayInStatusValue = (sensors) => {
  if (!sensors) return 0
  // 只查找 realy_in_status（实时数据）
  const sensor = sensors.find(s => s.type === 'realy_in_status')
  return sensor ? (sensor.value || 0) : 0
}
```

**重要说明**：
- `realy_in_status`（错误拼写）- 设备**实时上报**，时效性高
- `relay_in_status`（正确拼写）- 设备**10秒上报**，时效性低
- 前端只显示 `realy_in_status` 的值，确保用户看到的是最新状态

#### 4. 修改继电器控制按钮显示条件
```vue
<!-- 排除只读的继电器输入 -->
<button 
  v-if="isRelayType(sensor.type) && !isReadOnlyRelayInput(sensor.type) && authStore.canEdit"
  ...
>
```

#### 5. 更新状态指示器说明
- 更新 `title` 属性，明确标注"只读"
- 优化提示文字，说明 ON/OFF 的含义

### 后端修复 (`backend/services/mqtt_service.py`)

#### 1. 自定义 JSON 配置解析（第283行）
```python
# 添加 relay_in_status 支持
if key_lower in ['relay_status', 'relay', 'switch', 'switch_status', 'realy_in_status', 'relay_in_status'] or \
   'relay' in key_lower or 'switch' in key_lower or 'realy' in key_lower:
```

#### 2. 默认 JSON 解析 - 字符串类型（第326行）
```python
# 添加 relay_in_status 支持
if key_lower in ['relay_status', 'relay', 'switch', 'switch_status', 'realy_in_status', 'relay_in_status'] or \
   'relay' in key_lower or 'switch' in key_lower or 'realy' in key_lower:
    ...
    # 支持两种拼写
    if key_lower in ['realy_in_status', 'relay_in_status']:
        display_name = "继电器输入"
    else:
        display_name = "继电器"
```

#### 3. 默认 JSON 解析 - 数字类型（第355行）
```python
elif 'relay' in key_lower or 'realy' in key_lower:
    # 支持两种拼写
    if key_lower in ['realy_in_status', 'relay_in_status']:
        display_name = "继电器输入"
    else:
        display_name = "继电器"
```

## 修复效果

### ✅ 修复后的表现

1. **不再重复显示**
   - 继电器输入只在卡片头部右侧显示状态指示器
   - 不会出现在"其他传感器"列表中

2. **兼容两种拼写**
   - 同时支持 `realy_in_status`（错误拼写）和 `relay_in_status`（正确拼写）
   - 前后端统一处理，确保数据正确显示

3. **控制按钮正确显示**
   - 继电器输入（只读）不显示控制按钮
   - 其他可控制的继电器类型正常显示控制按钮

4. **用户体验改善**
   - 状态指示器明确标注"只读"
   - 提示信息更清晰（ON（有输入）/ OFF（无输入））

## 测试建议

1. **测试拼写兼容性**
   - 发送包含 `realy_in_status` 的 MQTT 消息
   - 发送包含 `relay_in_status` 的 MQTT 消息
   - 确认两种拼写都能正确显示

2. **测试显示逻辑**
   - 确认继电器输入只在头部显示一次
   - 确认不出现控制按钮
   - 确认状态正确切换（ON/OFF）

3. **测试其他继电器**
   - 确认其他继电器类型（如 `Relay Status`）仍然显示控制按钮
   - 确认控制功能正常工作

## 相关文件

- `frontend/src/views/Dashboard.vue` - 前端首页组件
- `backend/services/mqtt_service.py` - MQTT 数据处理服务
- `backend/test_set_readonly_sensors.py` - 只读传感器配置测试脚本
- `backend/migrate_add_readonly_sensor_types.py` - 数据库迁移脚本

## 注意事项

1. **向后兼容**：保留对错误拼写 `realy_in_status` 的支持，确保历史数据正常显示
2. **只读语义**：继电器输入是只读的外部输入状态检测，不应提供控制功能
3. **代码一致性**：前后端统一处理两种拼写，避免数据显示不一致
