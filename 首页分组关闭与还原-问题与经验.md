# 首页分组关闭与还原 — 问题与经验总结

## 一、需求背景

- 设备卡片上有**环境组 / 流程组**等分组区块。
- 用户希望：**不想展示某个分组时，点该分组上的 X 关闭**，分组即隐藏。
- 提供**还原**能力：可**一键恢复该设备下所有已关闭的分组**。

---

## 二、遇到的问题与解决

### 1. 还原按钮何时显示？

**问题**：最初还原按钮始终展示（只要有隐藏分组就显示），用户反馈「太明显」。

**尝试**：改为**仅当该设备全部分组都被关闭时才显示**还原按钮。

**新问题**：设备有 20+ 个分组时，要**先关掉 20 个**才能看到还原，才能恢复，不符合使用习惯。

**最终方案**：**只要有任意一个分组被关闭，就显示还原按钮**。点一次还原即恢复该设备下**全部**已关闭分组。这样关 1 个即可看到还原，操作成本低。

**经验**：  
- 显隐逻辑要照顾**操作步数**和**心理负担**，不能只考虑「界面干净」。  
- 「需要还原」= 存在可还原内容即可，不必等到「全部关闭」才给入口。

---

### 2. 还原按钮「太明显」怎么处理？

**问题**：还原按钮存在感过强，但又不能在「需要还原」时藏起来。

**做法**：  
- **样式弱化**：无边框、无背景、小号灰色字（`btn-restore-subtle`），悬停略加深，不抢焦点。  
- **自动隐藏**：关闭分组后还原按钮出现，**若 3 秒内未点击还原，则自动隐藏**；再关闭任一分组时再次出现，并重新计时。

**经验**：  
- 「明显」可通过**视觉弱化 + 自动消失**来平衡，而不是简单不显示。  
- 定时自动隐藏要让用户**有办法再次唤出**（如再关一个分组），否则会变成「找不到还原」。

---

### 3. 「3 秒内不点击关闭按钮则隐藏还原」的歧义

**原始表述**：「如果 3 秒内不点击关闭按钮，则自动隐藏还原按钮。」

**歧义**：  
- 「关闭按钮」可能指：分组上的 **X**，或还原区域的**关闭/收起**。  
- 若理解为「不点 X」则隐藏还原，逻辑难闭环。

**采用理解**：  
- **3 秒**：自「还原按钮出现」起算（即用户关闭了某分组之后）。  
- **不点击**：指**不点击「还原」按钮**。  
- **结果**：3 秒内没点还原 → 还原按钮自动隐藏；若点了还原 → 执行恢复，还原按钮因无隐藏分组而自然消失。

**经验**：  
- 需求里涉及多个按钮（X、还原、关闭）时，要**明确是谁触发、对谁生效**，避免实现与预期不一致。

---

### 4. 技术实现要点

- **状态**：  
  - `hiddenGroupKeys`：已隐藏的分组（如 `deviceId-groupType-number`）。  
  - `restoreAutoHidden`：因 3 秒超时而自动隐藏了还原按钮的设备 id。  
  - `restoreHideTimers`：按设备存的 3 秒定时器 id，便于重置与清理。

- **逻辑**：  
  - 关闭分组 → 更新 `hiddenGroupKeys`，清除该设备旧定时器，从 `restoreAutoHidden` 移除，启动新的 3 秒定时器。  
  - 3 秒到 → 把该设备加入 `restoreAutoHidden`，还原按钮隐藏。  
  - 点击还原 → 清除定时器，清空该设备在 `hiddenGroupKeys` 中的记录，还原按钮随无隐藏分组而消失。  
  - 再次关闭任一分组 → 还原按钮再次显示，定时器重新计时。

- **生命周期**：页面卸载时清除所有 `restoreHideTimers`，避免泄漏。

---

## 三、经验小结

| 维度 | 经验 |
|------|------|
| **交互** | 还原等「补救」操作的入口要**易于触达**（如关 1 个即出现），避免为减少打扰而过度隐藏。 |
| **视觉** | 可通过**弱样式 + 限时显示**降低存在感，而不是一味不展示。 |
| **语义** | 涉及多个按钮、多种「关闭」时，**写清触发条件、作用对象**，减少歧义。 |
| **实现** | 定时显隐要配合**重置条件**（如再关一个分组）和**卸载清理**，避免状态残留或计时器泄漏。 |

---

## 四、当前行为速览

1. 分组右上角 **X**：关闭该分组，分组隐藏。  
2. 关闭**任意**分组后，出现**还原**按钮（弱样式）。  
3. **3 秒内**点击还原 → 恢复该设备全部已关闭分组，还原按钮消失。  
4. **3 秒内未**点击还原 → 还原按钮自动隐藏；再关闭任一分组 → 再次出现并重新计时。

---

*文档对应实现：首页设备卡片分组关闭、还原及 3 秒自动隐藏还原按钮。*
