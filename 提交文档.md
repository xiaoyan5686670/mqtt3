# 提交说明 - 继电器控制多设备隔离与乐观更新优化

## 基本信息

- **日期**: 2026-01-14
- **分支**: main
- **范围**: 后端主题路由逻辑、MQTT 服务、TopicConfig 服务、前端 Dashboard / RealTimeData / SubscribeOptions、继电器控制文档

## 本次改动目标

1. 修复之前所有设备共用 `pc/1` 主题导致“互相影响”的问题，实现**按设备隔离的控制主题**。
2. 支持在 TopicConfig 中为设备配置独立的发布主题，并在设备未显式关联时**按设备名自动匹配 TopicConfig**。
3. 修复继电器开关“点击后要等下一次数据才更新”的体验问题，引入**乐观更新 + 期望状态保护机制**，避免表面“开关失灵”。
4. 补全并同步 `RELAY_CONTROL_LOGIC.md` 文档，让实现逻辑与代码保持一致，方便后续维护和排查问题。

## 具体改动内容

### 一、后端：按设备隔离主题 & TopicConfig 自动匹配

**涉及文件**:
- `backend/api/devices.py`
- `backend/services/topic_config_service.py`
- `backend/services/mqtt_service.py`

**关键改动**:

- `GET /api/devices/{device_id}/publish-topic`:
  - 优先使用设备关联的 `TopicConfig.publish_topic` 作为控制主题。
  - 当 `topic_config_id` 为空或对应配置未设置 `publish_topic` 时，引入**自动匹配逻辑**：
    - 根据设备名称（如 `stm32_3`、`stm32-3`、`stm32/3`）生成一组「可能的主题」。
    - 在所有激活的 TopicConfig 中，解析 `subscribe_topics`：
      - 支持 JSON 数组、换行分隔、逗号分隔三种格式。
      - 优先精确匹配可能的主题，其次通过归一化（`/`、`_`、`-` 统一为 `_`）进行等价匹配。
    - 匹配成功则使用匹配到的 TopicConfig 的 `publish_topic`，并在返回的 `source` 字段中标记为 `auto_matched_topic_config`。
  - 默认兜底主题从硬编码的 `pc/1` 改为**按设备隔离**的 `pc/{device_id}`，避免不同设备互相影响。

- `topic_config_service.find_topic_config_by_device_name`（新增）:
  - 封装“基于设备名自动匹配 TopicConfig”的逻辑，供 `devices.py` 调用。

- MQTT 发布逻辑优化:
  - 在 `MQTTService.publish_message` 中增加对连接状态的等待与详细日志，确保发布前已建立连接。
  - 日志中清晰记录发布主题、payload、消息 ID，便于与设备侧日志对比排查。

### 二、前端：继电器控制按设备主题 & 乐观更新

**涉及文件**:
- `frontend/src/views/RealTimeData.vue`
- `frontend/src/views/Dashboard.vue`
- `frontend/src/views/SubscribeOptions.vue`

**按设备获取控制主题**:
- 封装 `fetchPublishTopic(deviceId)`：
  - 调用 `/api/devices/{id}/publish-topic` 获取当前设备真实的发布主题。
  - 成功时使用返回的 `publish_topic`；
  - 失败时退回到 `pc/{deviceId}`，保证“按设备隔离”的下限。
- 替换原来的硬编码 `const topic = 'pc/1'`：
  - Dashboard 继电器按钮 + RealTimeData 控制按钮统一使用上述方法获取主题。
  - 确保控制某一台设备不会影响订阅其它主题/设备的终端。

**乐观更新 + 期望状态保护**:

- `RealTimeData.vue`:
  - 增加 `relayExpectedState` 对象，记录：
    - `value`: 期望的继电器状态（0/1）；
    - `timestamp`: 最近一次操作时间；
    - `timeout`: 保护时间窗口（目前为 5 秒）。
  - 在点击开关并成功调用 `/api/mqtt/publish` 后：
    - **立即**将 `sensorData.relay` 更新为期望状态（0 或 1），实现乐观更新。
    - 将期望状态与时间戳写入 `relayExpectedState`，开启“保护期”。
  - 在轮询 `/api/devices/{id}/latest-sensors` 时，对 `Relay Status` 数据做特殊处理：
    - 在保护期内且服务器返回值与期望状态一致 → 认为状态已确认，清除期望状态，并使用服务器数据。
    - 在保护期内但服务器返回值与期望状态不一致 → 认为是“旧数据”，继续显示期望状态（不闪回）。
    - 超出保护期 → 不再保护，完全信任服务器数据。

- `Dashboard.vue`:
  - 新增 `relayExpectedStates: Map<deviceId-sensorType, { value, timestamp, timeout }>`，用以支持多设备多继电器的期望状态管理。
  - 在发送控制指令成功后：
    - 将期望状态写入 `relayExpectedStates`，键为 `deviceId-sensorType`。
    - 同时更新 `devicesWithSensors` 与 `filteredDevices` 中对应传感器的 `value`，实现**即时 UI 更新**。
  - 在周期性刷新 `devicesWithSensors` 时：
    - 对 `Relay` 类型传感器检查是否存在对应期望状态，逻辑与 RealTimeData 一致：
      - 保护期内 + 值一致 → 确认并清除；
      - 保护期内 + 值不一致 → 使用期望状态（屏蔽闪回）；
      - 超时 → 删除期望状态，使用服务器值。

**SubscribeOptions 提示文案更新**:
- 将“示例主题”文案从单一的 `pc/1` 更新为 “`pc/1`、`pc/2`（建议按设备区分主题）”，引导用户为不同设备配置不同主题，减少串扰。

### 三、文档同步更新

**涉及文件**:
- `RELAY_CONTROL_LOGIC.md`
- `README.md`

**RELAY_CONTROL_LOGIC.md**:
- 将早期“统一使用 `pc/1`”的描述整体改为：
  - 默认按设备隔离 `pc/{device_id}`；
  - TopicConfig 可显式配置 `publish_topic`；
  - 当设备未显式关联 TopicConfig 时，说明自动匹配的逻辑与匹配优先级。
- 新增“主题配置机制”小节中：
  - 方式一：**手动关联 TopicConfig**（推荐）——设备显式选择 `topic_config_id`。
  - 方式二：**自动匹配 TopicConfig**——根据 `subscribe_topics` 与设备名自动关联。
- 新增“乐观更新机制（Optimistic Update）”章节：
  - 描述问题场景；
  - 如何通过乐观更新 + 期望状态保护解决“开关看起来失灵”的体验问题；
  - 给出 `RealTimeData.vue` 与 `Dashboard.vue` 的核心伪代码片段。
- 更新“数据流”章节：
  - 插入“前端乐观更新 + 后端确认 + 前端期望状态保护”的完整链路步骤。
- 更新“总结”：
  - 新增“自动匹配 TopicConfig”、“乐观更新机制”两条能力说明。

**README.md**:
- 在底部追加了一段“继电器控制按钮优化完成”的 BUG 修复记录，概述本次提交涵盖的：
  - 防抖机制；
  - 状态管理与日志改进；
  - 乐观更新思路（简要）。

## 建议的回归测试项

1. **多设备控制隔离**:
   - 为多台设备配置不同 TopicConfig 或默认 `pc/{id}`。
   - 分别点击 Dashboard 和 RealTimeData 页面上的继电器按钮，确认不会相互影响。

2. **自动匹配 TopicConfig**:
   - 设备未设置 `topic_config_id`，仅通过设备名（如 `stm32_3`）和 TopicConfig `subscribe_topics`（如 `stm32/3`）建立关系。
   - 确认控制时发布到 TopicConfig 配置的 `publish_topic`，而不是默认的 `pc/{id}`。

3. **乐观更新体验**:
   - 在网络/设备有一定延迟的环境下，快速连续点击开启/关闭按钮：
     - UI 状态应立即变化；
     - 不再出现“点击后 UI 一直不变”的假死感；
     - 最终状态需与实际设备状态一致。

4. **回退与兼容性**:
   - 在没有配置 TopicConfig、设备名称为普通字符串（非 `pc_*` / `stm32_*`）时，仍能正常使用默认 `pc/{id}` 主题进行控制。

