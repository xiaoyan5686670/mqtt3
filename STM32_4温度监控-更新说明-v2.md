# STM32_4 温度监控模块 - 更新说明 (v2.0)

## 📋 版本信息

| 项目 | 内容 |
|------|------|
| 版本 | v2.0 |
| 更新日期 | 2026-01-21 |
| 更新类型 | 逻辑重构 |
| 状态 | ✅ 已完成 |

---

## 🔄 主要变更

### 1. 组件分组方式改变

#### v1.0 (旧版)
- 4个独立的温度卡片
- 每个温度独立判断是否正常

#### v2.0 (新版)
- **2个压缩机组件**
- 每个组件包含进出口温度对
- 按压缩机组判断运行状态

### 2. 分组逻辑

```
┌─────────────────────────────────────────────────────────┐
│                    压缩机1组件                          │
│  ┌──────────────────┐      ┌──────────────────┐        │
│  │ comp1_in_temp_F  │  →   │ comp1_out_temp_F │        │
│  │   (入口温度)      │      │   (出口温度)      │        │
│  └──────────────────┘      └──────────────────┘        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    压缩机2组件                          │
│  ┌──────────────────┐      ┌──────────────────┐        │
│  │ comp2_in_temp_F  │  →   │ comp2_out_temp_F │        │
│  │   (入口温度)      │      │   (出口温度)      │        │
│  └──────────────────┘      └──────────────────┘        │
└─────────────────────────────────────────────────────────┘
```

### 3. 告警逻辑变更

#### v1.0 告警条件（已废弃）
```
单个温度 >= 85°F → 告警
```

#### v2.0 告警条件（当前）
```
出口温度 < 入口温度 → 告警 + 风扇停转
```

**说明**：正常情况下，压缩机工作时出口温度应该高于入口温度。如果出现出口温度低于入口温度的情况，说明系统运行异常。

---

## 🎨 UI 变更对比

### v1.0 布局（旧版）
```
┌────────────────────────────────────────────────────────┐
│  [温度1]    [温度2]    [温度3]    [温度4]              │
│  4个独立卡片，横向排列                                  │
└────────────────────────────────────────────────────────┘
```

### v2.0 布局（新版）
```
┌─────────────────────────┬─────────────────────────┐
│    压缩机1组件           │    压缩机2组件           │
│  ┌────────┐            │  ┌────────┐            │
│  │ 🌀 风扇 │ 标题       │  │ 🌀 风扇 │ 标题       │
│  └────────┘            │  └────────┘            │
│                        │                        │
│  入口温度 → 出口温度    │  入口温度 → 出口温度    │
│   75.0°F     80.0°F   │   78.0°F     85.0°F   │
│                        │                        │
│   ✓ 正常运行           │   ✓ 正常运行           │
└─────────────────────────┴─────────────────────────┘
```

---

## ✨ 新增功能

### 1. 压缩机组件卡片
- **组件头部**：
  - 风扇图标（可旋转）
  - 压缩机名称（中英文）
  
- **温度对显示**：
  - 入口温度（左侧，带向下箭头图标）
  - 箭头指示（中间）
  - 出口温度（右侧，带向上箭头图标）
  
- **状态标签**：
  - 正常：✓ 正常运行
  - 异常：⚠ 温度异常 (出口 < 入口)

### 2. 动态效果

#### 正常状态
- ✅ 风扇持续旋转（2秒/圈）
- ✅ 绿色边框
- ✅ 淡绿色背景渐变
- ✅ 温度值显示为绿色
- ✅ 箭头为紫色

#### 异常状态  
- ⚠️ 风扇停止旋转
- ⚠️ 红色边框 + 呼吸动画
- ⚠️ 淡红色背景渐变
- ⚠️ 温度值变红并闪烁
- ⚠️ 箭头变红色
- ⚠️ 风扇背景变红

---

## 🔧 技术实现

### 新增方法

#### 1. `getCompressorTemp(compressorNum, type)`
获取指定压缩机的指定类型温度值

**参数**：
- `compressorNum`: 1 或 2（压缩机编号）
- `type`: 'in' 或 'out'（入口或出口）

**返回**：温度值字符串，如 "75.0" 或 "--"（无数据）

```javascript
const getCompressorTemp = (compressorNum, type) => {
  if (!stm32Device.value) return '--'
  const sensorType = `comp${compressorNum}_${type}_temperature_F`
  const sensor = stm32Device.value.sensors.find(s => s.type === sensorType)
  if (!sensor || sensor.value === null || sensor.value === undefined) return '--'
  return formatSensorValue(sensor.value)
}
```

#### 2. `isCompressorNormal(compressorNum)`
判断指定压缩机是否正常运行

**判断逻辑**：
- 出口温度 >= 入口温度 → 正常（返回 true）
- 出口温度 < 入口温度 → 异常（返回 false）
- 任一温度缺失 → 异常（返回 false）

```javascript
const isCompressorNormal = (compressorNum) => {
  if (!stm32Device.value) return false
  
  const inSensorType = `comp${compressorNum}_in_temperature_F`
  const outSensorType = `comp${compressorNum}_out_temperature_F`
  
  const inSensor = stm32Device.value.sensors.find(s => s.type === inSensorType)
  const outSensor = stm32Device.value.sensors.find(s => s.type === outSensorType)
  
  if (!inSensor || !outSensor || 
      inSensor.value === null || inSensor.value === undefined ||
      outSensor.value === null || outSensor.value === undefined) {
    return false
  }
  
  return outSensor.value >= inSensor.value
}
```

#### 3. `getCompressorGroupClass(compressorNum)`
获取压缩机组件的 CSS 类名

**返回**：
- 'compressor-normal' 或 'compressor-abnormal'

```javascript
const getCompressorGroupClass = (compressorNum) => {
  return isCompressorNormal(compressorNum) ? 'compressor-normal' : 'compressor-abnormal'
}
```

### 移除的方法（v1.0）
- ~~`stm32TemperatureSensors`~~ (计算属性)
- ~~`isTempNormal(sensor)`~~
- ~~`getTempCardClass(sensor)`~~

---

## 🎨 CSS 类名变更

### 新增类名

| 类名 | 用途 |
|------|------|
| `.compressor-group` | 压缩机组件容器 |
| `.compressor-normal` | 正常状态修饰符 |
| `.compressor-abnormal` | 异常状态修饰符 |
| `.compressor-header` | 组件头部 |
| `.compressor-icon-wrapper` | 风扇图标容器 |
| `.compressor-fan-icon` | 风扇图标 |
| `.compressor-title` | 压缩机标题 |
| `.temperature-pair` | 温度对容器 |
| `.temp-item` | 单个温度项 |
| `.temp-item-label` | 温度标签 |
| `.temp-item-value` | 温度数值 |
| `.temp-arrow` | 箭头指示器 |
| `.compressor-status` | 状态标签容器 |

### 移除的类名（v1.0）
- ~~`.temp-card`~~
- ~~`.temp-normal`~~
- ~~`.temp-abnormal`~~
- ~~`.temp-header`~~
- ~~`.temp-icon-wrapper`~~
- ~~`.temp-fan-icon`~~
- ~~`.temp-label`~~
- ~~`.temp-value`~~
- ~~`.temp-status`~~

---

## 📱 响应式设计

### 桌面布局 (≥768px)
```
┌──────────────────────┬──────────────────────┐
│   压缩机1组件         │   压缩机2组件         │
│   50% 宽             │   50% 宽             │
│                      │                      │
│  入口 → 出口          │  入口 → 出口          │
│  (横向排列)           │  (横向排列)           │
└──────────────────────┴──────────────────────┘
```

### 移动布局 (<768px)
```
┌──────────────────────┐
│   压缩机1组件         │
│   100% 宽            │
│                      │
│      入口            │
│       ↓              │
│      出口            │
│   (纵向堆叠)          │
├──────────────────────┤
│   压缩机2组件         │
│   100% 宽            │
│                      │
│      入口            │
│       ↓              │
│      出口            │
│   (纵向堆叠)          │
└──────────────────────┘
```

---

## 🧪 测试场景

### 场景1：正常运行
```
压缩机1: 入口 75°F, 出口 80°F  (80 >= 75) ✅ 正常
压缩机2: 入口 78°F, 出口 85°F  (85 >= 78) ✅ 正常

预期效果:
- 两个风扇都旋转
- 绿色边框
- 温度值显示为绿色
- 状态: ✓ 正常运行
```

### 场景2：压缩机1异常
```
压缩机1: 入口 75°F, 出口 70°F  (70 < 75) ⚠️ 异常
压缩机2: 入口 78°F, 出口 85°F  (85 >= 78) ✅ 正常

预期效果:
- 压缩机1风扇停止，红色边框，温度闪烁
- 压缩机2风扇旋转，绿色边框，正常显示
- 状态: ⚠ 温度异常 (出口 < 入口)
```

### 场景3：压缩机2异常
```
压缩机1: 入口 75°F, 出口 80°F  (80 >= 75) ✅ 正常
压缩机2: 入口 85°F, 出口 80°F  (80 < 85) ⚠️ 异常

预期效果:
- 压缩机1风扇旋转，绿色边框，正常显示
- 压缩机2风扇停止，红色边框，温度闪烁
- 状态: ⚠ 温度异常 (出口 < 入口)
```

### 场景4：两个都异常
```
压缩机1: 入口 75°F, 出口 70°F  (70 < 75) ⚠️ 异常
压缩机2: 入口 85°F, 出口 80°F  (80 < 85) ⚠️ 异常

预期效果:
- 两个风扇都停止
- 红色边框 + 呼吸动画
- 温度值闪烁
- 状态: ⚠ 温度异常 (出口 < 入口)
```

### 场景5：数据缺失
```
压缩机1: 入口 --, 出口 80°F  ⚠️ 异常（数据不完整）
压缩机2: 入口 78°F, 出口 --  ⚠️ 异常（数据不完整）

预期效果:
- 两个风扇都停止
- 红色边框
- 显示 "--" 表示缺失数据
- 状态: ⚠ 温度异常 (出口 < 入口)
```

---

## 🔍 数据流变化

### v1.0 数据流
```
传感器数据 → 过滤4个温度 → 逐个判断是否 >= 85°F → 渲染4个卡片
```

### v2.0 数据流
```
传感器数据 
    ├→ 压缩机1: 获取 in + out → 比较 (out >= in) → 渲染组件1
    └→ 压缩机2: 获取 in + out → 比较 (out >= in) → 渲染组件2
```

---

## 📊 对比表格

| 特性 | v1.0 | v2.0 |
|------|------|------|
| 显示单位 | 4个独立卡片 | 2个压缩机组件 |
| 分组方式 | 无分组 | 按压缩机分组 |
| 告警逻辑 | 单温度阈值 | 进出口温度比较 |
| 温度阈值 | 85°F | 无固定阈值 |
| 判断依据 | 绝对温度值 | 相对温度差 |
| 布局 | 4列 | 2列 |
| 关联性 | 独立 | 成对关联 |

---

## 🚀 快速测试

### 1. 启动系统
```bash
cd /Users/qinxiaoyan/work/mqtt3
./start_backend.sh     # 终端1
./start_frontend.sh    # 终端2
```

### 2. 访问页面
```
http://192.168.1.102:5173/dashboard
```

### 3. 模拟异常（MQTT）
发送测试数据使出口温度低于入口温度：

```bash
# 压缩机1异常: 入口75, 出口70
mosquitto_pub -h <MQTT服务器> -t "stm32_4/data" \
  -m '{"comp1_in_temperature_F": 75.0, "comp1_out_temperature_F": 70.0}'

# 压缩机2异常: 入口85, 出口80
mosquitto_pub -h <MQTT服务器> -t "stm32_4/data" \
  -m '{"comp2_in_temperature_F": 85.0, "comp2_out_temperature_F": 80.0}'
```

---

## 📝 检查清单

升级到 v2.0 后请检查：

- [ ] 页面显示2个压缩机组件（不是4个独立卡片）
- [ ] 每个组件显示标题、风扇图标、进出口温度
- [ ] 入口温度在左侧，出口温度在右侧
- [ ] 中间有箭头指示
- [ ] 当出口 >= 入口时，风扇旋转，绿色主题
- [ ] 当出口 < 入口时，风扇停止，红色主题，温度闪烁
- [ ] 状态标签准确显示
- [ ] 响应式布局正常（桌面2列，移动1列）
- [ ] 数据每2秒自动刷新

---

## ⚠️ 注意事项

1. **兼容性**：确保传感器数据包含以下字段：
   - `comp1_in_temperature_F`
   - `comp1_out_temperature_F`
   - `comp2_in_temperature_F`
   - `comp2_out_temperature_F`

2. **数据完整性**：如果任一温度缺失，组件会显示为异常状态

3. **温度单位**：固定为华氏度 (°F)

4. **性能**：新版本减少了DOM元素数量（从4个卡片减少到2个组件），性能更优

---

## 🔄 回滚方法

如需回滚到 v1.0：

```bash
git checkout <v1.0-commit-hash> frontend/src/views/Dashboard.vue
```

或参考 v1.0 文档手动恢复。

---

## 📚 相关文档

- **v1.0 文档**:
  - STM32_4温度监控模块说明.md
  - STM32_4温度监控-测试指南.md
  - STM32_4温度监控-可视化示意.md
  - STM32_4温度监控-快速参考.md

- **v2.0 文档**:
  - STM32_4温度监控-更新说明-v2.md (本文档)
  - STM32_4温度监控-快速参考-v2.md (推荐)

---

**更新完成时间**: 2026-01-21  
**版本**: v2.0  
**状态**: ✅ 已完成并测试
