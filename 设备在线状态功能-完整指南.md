# è®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€åŠŸèƒ½ - å®Œæ•´æŒ‡å—

## âœ… åŠŸèƒ½å·²é…ç½®å®Œæˆ

æ‚¨çš„ EMQX API Key å·²ç»é…ç½®æˆåŠŸï¼š
- API Key: `f3d064c3dacad617`
- Secret Key: `ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP`
- API ç«¯å£: `18083`
- EMQX æœåŠ¡å™¨: `172.16.208.176`

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. Dashboard é¦–é¡µç»Ÿè®¡å¡ç‰‡
åœ¨é¦–é¡µé¡¶éƒ¨æ˜¾ç¤ºä¸‰ä¸ªç»Ÿè®¡å¡ç‰‡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“Š æ€»è®¾å¤‡æ•°    â”‚   âœ… åœ¨çº¿è®¾å¤‡    â”‚   âŒ ç¦»çº¿è®¾å¤‡    â”‚
â”‚       10        â”‚        7        â”‚        3        â”‚
â”‚   (ç´«è‰²æ¸å˜)     â”‚   (ç»¿è‰²æ¸å˜)     â”‚   (çº¢è‰²æ¸å˜)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è®¾å¤‡å¡ç‰‡çŠ¶æ€æŒ‡ç¤ºå™¨
æ¯ä¸ªè®¾å¤‡å¡ç‰‡çš„å·¦ä¸Šè§’æ˜¾ç¤ºçŠ¶æ€åœ†ç‚¹ï¼š

- ğŸŸ¢ **ç»¿è‰²åœ†ç‚¹** = è®¾å¤‡åœ¨çº¿ï¼ˆå¸¦è„‰å†²åŠ¨ç”»æ•ˆæœï¼‰
- ğŸ”´ **çº¢è‰²åœ†ç‚¹** = è®¾å¤‡ç¦»çº¿

### 3. æ–°å¢èœå•é¡¹
åœ¨å¯¼èˆªæ å¢åŠ "EMQX APIé…ç½®"èœå•é¡¹ï¼Œå¯ä»¥ï¼š
- æŸ¥çœ‹å½“å‰ API é…ç½®
- ä¿®æ”¹ API Key å’Œ Secret Key
- æµ‹è¯• API è¿æ¥
- æŸ¥çœ‹è¿æ¥çŠ¶æ€å’Œå®¢æˆ·ç«¯æ•°é‡

### 4. è‡ªåŠ¨åˆ·æ–°
ç³»ç»Ÿæ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°è®¾å¤‡çŠ¶æ€ï¼Œä¿è¯æ•°æ®å®æ—¶æ€§ã€‚

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
source venv/bin/activate
python main.py
```

### 2. å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd frontend
npm run dev
```

### 3. è®¿é—®ç³»ç»Ÿ

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5173

## ğŸ“‹ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤1: ç™»å½•ç³»ç»Ÿ
ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ç³»ç»Ÿã€‚

### æ­¥éª¤2: æŸ¥çœ‹ Dashboard
ç™»å½•åä¼šè‡ªåŠ¨è¿›å…¥ Dashboard é¦–é¡µï¼Œæ‚¨åº”è¯¥èƒ½çœ‹åˆ°ï¼š
- âœ… é¡¶éƒ¨çš„ç»Ÿè®¡å¡ç‰‡ï¼ˆæ€»è®¾å¤‡æ•°ã€åœ¨çº¿è®¾å¤‡æ•°ã€ç¦»çº¿è®¾å¤‡æ•°ï¼‰
- âœ… æ¯ä¸ªè®¾å¤‡å¡ç‰‡å·¦ä¸Šè§’çš„çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆç»¿è‰²æˆ–çº¢è‰²åœ†ç‚¹ï¼‰

### æ­¥éª¤3: ç®¡ç† API é…ç½®ï¼ˆå¯é€‰ï¼‰
å¦‚æœéœ€è¦ä¿®æ”¹ API Keyï¼š
1. ç‚¹å‡»å¯¼èˆªæ çš„"EMQX APIé…ç½®"
2. è¾“å…¥æ–°çš„ API Key å’Œ Secret Key
3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯é…ç½®
4. ç‚¹å‡»"ä¿å­˜é…ç½®"

## ğŸ”§ æŠ€æœ¯å®ç°

### æ¶æ„æµç¨‹

```
å‰ç«¯ Dashboard
     â†“
è°ƒç”¨ GET /api/mqtt-publish/clients
     â†“
åç«¯ mqtt_publish.py
     â†“
è°ƒç”¨ mqtt_service.get_emqx_clients()
     â†“
è¯»å–æ•°æ®åº“ä¸­çš„ API Key é…ç½®
     â†“
è°ƒç”¨ EMQX REST API
GET http://172.16.208.176:18083/api/v5/clients
     â†“
è¿”å›å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€
     â†“
å‰ç«¯åŒ¹é…è®¾å¤‡IDå’Œå®¢æˆ·ç«¯ID
     â†“
æ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿çŠ¶æ€
```

### API ç«¯ç‚¹

#### å‰ç«¯è°ƒç”¨çš„ API

**1. è·å–å®¢æˆ·ç«¯çŠ¶æ€**
```
GET /api/mqtt-publish/clients
Authorization: Bearer {token}
```

**2. è·å– EMQX API é…ç½®**
```
GET /api/emqx-api-config
Authorization: Bearer {token}
```

**3. ä¿å­˜ EMQX API é…ç½®**
```
POST /api/emqx-api-config
Content-Type: application/json

{
  "api_port": 18083,
  "api_key": "f3d064c3dacad617",
  "api_secret": "ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP"
}
```

**4. æµ‹è¯• EMQX API è¿æ¥**
```
POST /api/emqx-api-config/test
Content-Type: application/json

{
  "api_port": 18083,
  "api_key": "f3d064c3dacad617",
  "api_secret": "ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP"
}
```

#### åç«¯è°ƒç”¨çš„ EMQX API

```
GET http://172.16.208.176:18083/api/v5/clients?limit=10000
Authorization: Basic {base64(api_key:api_secret)}
```

## ğŸ’¾ æ•°æ®åº“å˜æ›´

### mqtt_configs è¡¨æ–°å¢å­—æ®µ

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| api_port | INTEGER | 18083 | EMQX API ç«¯å£ |
| api_key | TEXT | NULL | EMQX API Key |
| api_secret | TEXT | NULL | EMQX Secret Key |

### è¿ç§»è„šæœ¬

å·²æ‰§è¡Œçš„è¿ç§»è„šæœ¬ï¼š
- `migrate_add_emqx_api_fields.py` - æ·»åŠ  EMQX API é…ç½®å­—æ®µ
- `setup_emqx_api_key.py` - é…ç½®ç”¨æˆ·æä¾›çš„ API Key

## ğŸ“ æ–‡ä»¶æ¸…å•

### å‰ç«¯æ–‡ä»¶

1. **frontend/src/views/EmqxApiConfig.vue** - EMQX API é…ç½®é¡µé¢
2. **frontend/src/views/Dashboard.vue** - Dashboard é¦–é¡µï¼ˆå·²æ›´æ–°ï¼‰
3. **frontend/src/router/index.js** - è·¯ç”±é…ç½®ï¼ˆå·²æ›´æ–°ï¼‰
4. **frontend/src/App.vue** - ä¸»å¸ƒå±€å¯¼èˆªï¼ˆå·²æ›´æ–°ï¼‰

### åç«¯æ–‡ä»¶

1. **backend/api/emqx_api_config.py** - EMQX API é…ç½®æ¥å£
2. **backend/api/__init__.py** - è·¯ç”±æ³¨å†Œï¼ˆå·²æ›´æ–°ï¼‰
3. **backend/services/mqtt_service.py** - MQTT æœåŠ¡ï¼ˆå·²æ›´æ–°ï¼‰
4. **backend/models/mqtt_config.py** - æ•°æ®æ¨¡å‹ï¼ˆå·²æ›´æ–°ï¼‰
5. **backend/requirements.txt** - ä¾èµ–åŒ…ï¼ˆå·²æ›´æ–°ï¼Œæ·»åŠ  requestsï¼‰

### è¿ç§»è„šæœ¬

1. **backend/migrate_add_emqx_api_fields.py** - æ•°æ®åº“è¿ç§»è„šæœ¬
2. **backend/setup_emqx_api_key.py** - API Key å¿«é€Ÿé…ç½®è„šæœ¬

### æ–‡æ¡£

1. **è®¾å¤‡åœ¨çº¿çŠ¶æ€åŠŸèƒ½-å®Œæ•´æŒ‡å—.md** - æœ¬æ–‡æ¡£
2. **DEVICE_ONLINE_STATUS_FEATURE.md** - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
3. **EMQX_API_CONFIG.md** - EMQX API é…ç½®è¯´æ˜
4. **CHANGES.md** - ä¿®æ”¹æ¸…å•

## ğŸ” è®¾å¤‡åŒ¹é…è§„åˆ™

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ¤æ–­è®¾å¤‡æ˜¯å¦åœ¨çº¿ï¼š

```javascript
const isOnline = 
  onlineClientIds.has(device.id) ||    // åŒ¹é…è®¾å¤‡ID
  onlineClientIds.has(device.name)     // æˆ–åŒ¹é…è®¾å¤‡åç§°
```

**é‡è¦ï¼š** ç¡®ä¿æ‚¨çš„ MQTT è®¾å¤‡å®¢æˆ·ç«¯ ID (ClientID) ä¸ç³»ç»Ÿä¸­çš„è®¾å¤‡ ID æˆ–è®¾å¤‡åç§°ä¸€è‡´ã€‚

### ç¤ºä¾‹

å¦‚æœç³»ç»Ÿä¸­æœ‰è®¾å¤‡ï¼š
- ID: `1`
- Name: `device_001`

é‚£ä¹ˆ MQTT å®¢æˆ·ç«¯çš„ ClientID åº”è¯¥è®¾ç½®ä¸º `1` æˆ– `device_001`ã€‚

## ğŸ¨ UI æ•ˆæœå±•ç¤º

### ç»Ÿè®¡å¡ç‰‡æ ·å¼

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“Š æ€»è®¾å¤‡æ•°: 10                                  â•‘
â•‘  æ¸å˜èƒŒæ™¯è‰²: ç´«è‰² (#667eea â†’ #764ba2)             â•‘
â•‘  é¼ æ ‡æ‚¬åœ: ä¸Šç§»2px + é˜´å½±åŠ æ·±                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… åœ¨çº¿è®¾å¤‡: 7                                   â•‘
â•‘  æ¸å˜èƒŒæ™¯è‰²: ç»¿è‰² (#10b981 â†’ #059669)             â•‘
â•‘  é¼ æ ‡æ‚¬åœ: ä¸Šç§»2px + é˜´å½±åŠ æ·±                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âŒ ç¦»çº¿è®¾å¤‡: 3                                   â•‘
â•‘  æ¸å˜èƒŒæ™¯è‰²: çº¢è‰² (#ef4444 â†’ #dc2626)             â•‘
â•‘  é¼ æ ‡æ‚¬åœ: ä¸Šç§»2px + é˜´å½±åŠ æ·±                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### è®¾å¤‡å¡ç‰‡çŠ¶æ€æŒ‡ç¤ºå™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš« è®¾å¤‡A      [è®¾å¤‡å›¾æ ‡]           â”‚ <- ç»¿è‰²è„‰å†²åœ†ç‚¹(åœ¨çº¿)
â”‚ æ¸©åº¦: 25.0Â°C                       â”‚
â”‚ æ¹¿åº¦: 60.0%                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš« è®¾å¤‡B      [è®¾å¤‡å›¾æ ‡]           â”‚ <- çº¢è‰²åœ†ç‚¹(ç¦»çº¿)
â”‚ æ¸©åº¦: --                           â”‚
â”‚ æ¹¿åº¦: --                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ‰€æœ‰è®¾å¤‡æ˜¾ç¤ºç¦»çº¿

**å¯èƒ½åŸå› ï¼š**
1. EMQX æœåŠ¡æœªè¿è¡Œ
2. EMQX API ç«¯å£ (18083) ä¸å¯è®¿é—®
3. API Key è®¤è¯å¤±è´¥
4. è®¾å¤‡ ClientID ä¸ç³»ç»Ÿä¸­çš„è®¾å¤‡ ID/åç§°ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥ EMQX æœåŠ¡çŠ¶æ€
systemctl status emqx
# æˆ–
docker ps | grep emqx

# 2. æµ‹è¯• EMQX API è¿æ¥
curl -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients

# 3. æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f backend/logs/app.log

# 4. æ£€æŸ¥è®¾å¤‡ ClientID
# åœ¨ EMQX Dashboard ä¸­æŸ¥çœ‹å®¢æˆ·ç«¯åˆ—è¡¨
```

### é—®é¢˜2: API è°ƒç”¨å¤±è´¥ (401 Unauthorized)

**åŸå› ï¼š** API Key æˆ– Secret Key ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**
1. åœ¨ EMQX Dashboard ä¸­é‡æ–°ç”Ÿæˆ API Key
2. åœ¨å‰ç«¯"EMQX APIé…ç½®"é¡µé¢æ›´æ–°å¯†é’¥
3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯

### é—®é¢˜3: API è°ƒç”¨è¶…æ—¶

**åŸå› ï¼š** ç½‘ç»œè¿æ¥é—®é¢˜æˆ– EMQX æœåŠ¡å“åº”æ…¢

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦èƒ½è®¿é—® EMQX æœåŠ¡å™¨
2. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
3. å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆåœ¨ mqtt_service.py ä¸­ä¿®æ”¹ï¼‰

### é—®é¢˜4: ç»Ÿè®¡æ•°å­—ä¸å‡†ç¡®

**åŸå› ï¼š** ç¼“å­˜æˆ–åˆ·æ–°å»¶è¿Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç­‰å¾…è‡ªåŠ¨åˆ·æ–°ï¼ˆ5ç§’ï¼‰
2. æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨é¡µé¢ (F5)
3. æ£€æŸ¥åç«¯æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

## ğŸ“– åœ¨ EMQX Dashboard ä¸­åˆ›å»º API Key

å¦‚æœæ‚¨éœ€è¦åˆ›å»ºæ–°çš„ API Keyï¼š

### æ­¥éª¤1: è®¿é—® EMQX Dashboard
```
http://172.16.208.176:18083
```

### æ­¥éª¤2: ç™»å½•
ä½¿ç”¨ EMQX ç®¡ç†å‘˜è´¦å·ç™»å½•ï¼ˆé»˜è®¤: admin/publicï¼‰

### æ­¥éª¤3: åˆ›å»º API Key
1. è¿›å…¥"ç³»ç»Ÿè®¾ç½®" -> "API å¯†é’¥"
2. ç‚¹å‡»"åˆ›å»º"æŒ‰é’®
3. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š
   - åç§°: `mqtt_iot_system`
   - æè¿°: `MQTT IoTç®¡ç†ç³»ç»ŸAPIè®¿é—®`
   - è¿‡æœŸæ—¶é—´: æ ¹æ®éœ€è¦è®¾ç½®ï¼ˆå»ºè®®é€‰æ‹©"æ°¸ä¸è¿‡æœŸ"æˆ–è®¾ç½®è¾ƒé•¿æ—¶é—´ï¼‰
4. ç‚¹å‡»"åˆ›å»º"
5. **é‡è¦ï¼š** å¤åˆ¶ç”Ÿæˆçš„ API Key å’Œ Secret Keyï¼ˆSecret Key åªæ˜¾ç¤ºä¸€æ¬¡ï¼‰

### æ­¥éª¤4: åœ¨ç³»ç»Ÿä¸­é…ç½®
1. åœ¨æœ¬ç³»ç»Ÿä¸­ç‚¹å‡»"EMQX APIé…ç½®"èœå•
2. è¾“å…¥å¤åˆ¶çš„ API Key å’Œ Secret Key
3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"
4. è¿æ¥æˆåŠŸåç‚¹å‡»"ä¿å­˜é…ç½®"

## ğŸ“ ä½¿ç”¨æ•™ç¨‹

### æ•™ç¨‹1: é¦–æ¬¡é…ç½®

```bash
# 1. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœè¿˜æ²¡è¿è¡Œï¼‰
cd backend
source venv/bin/activate
python migrate_add_emqx_api_fields.py

# 2. é…ç½® API Keyï¼ˆä½¿ç”¨æä¾›çš„å¯†é’¥ï¼‰
python setup_emqx_api_key.py

# 3. å¯åŠ¨æœåŠ¡
python main.py
```

### æ•™ç¨‹2: åœ¨å‰ç«¯é…ç½® API Key

1. å¯åŠ¨ç³»ç»Ÿå¹¶ç™»å½•
2. ç‚¹å‡»å¯¼èˆªæ "EMQX APIé…ç½®"
3. é¡µé¢ä¼šæ˜¾ç¤ºå½“å‰é…ç½®ï¼š
   - API ç«¯å£: 18083
   - API Key: f3d064c3dacad617
   - Secret Key: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢
4. å¦‚éœ€ä¿®æ”¹ï¼Œè¾“å…¥æ–°å€¼åç‚¹å‡»"æµ‹è¯•è¿æ¥"
5. æµ‹è¯•æˆåŠŸåç‚¹å‡»"ä¿å­˜é…ç½®"

### æ•™ç¨‹3: éªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸

1. æ‰“å¼€ Dashboard é¦–é¡µ
2. æŸ¥çœ‹é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ï¼š
   - æ€»è®¾å¤‡æ•°åº”è¯¥æ˜¾ç¤ºç³»ç»Ÿä¸­çš„è®¾å¤‡æ€»æ•°
   - åœ¨çº¿è®¾å¤‡æ•°åº”è¯¥æ˜¾ç¤ºå½“å‰è¿æ¥åˆ° EMQX çš„è®¾å¤‡æ•°
   - ç¦»çº¿è®¾å¤‡æ•° = æ€»è®¾å¤‡æ•° - åœ¨çº¿è®¾å¤‡æ•°

3. æŸ¥çœ‹è®¾å¤‡å¡ç‰‡ï¼š
   - åœ¨çº¿è®¾å¤‡å·¦ä¸Šè§’æ˜¾ç¤ºç»¿è‰²åœ†ç‚¹ï¼ˆå¸¦è„‰å†²åŠ¨ç”»ï¼‰
   - ç¦»çº¿è®¾å¤‡å·¦ä¸Šè§’æ˜¾ç¤ºçº¢è‰²åœ†ç‚¹

4. æµ‹è¯•è‡ªåŠ¨åˆ·æ–°ï¼š
   - è®©ä¸€ä¸ª MQTT è®¾å¤‡è¿æ¥æˆ–æ–­å¼€
   - ç­‰å¾…æœ€å¤š 5 ç§’ï¼Œè§‚å¯ŸçŠ¶æ€æ˜¯å¦è‡ªåŠ¨æ›´æ–°

## ğŸ” å®‰å…¨é…ç½®

### API Key æƒé™è¯´æ˜

EMQX API Key å…·æœ‰ç®¡ç†æƒé™ï¼Œå¯ä»¥ï¼š
- æŸ¥çœ‹å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€
- æŸ¥çœ‹å®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯
- æ‰§è¡Œå…¶ä»–ç®¡ç†æ“ä½œ

**å®‰å…¨å»ºè®®ï¼š**
1. âœ… ä¸ºæœ¬ç³»ç»Ÿå•ç‹¬åˆ›å»º API Key
2. âœ… å®šæœŸæ›´æ¢ API Keyï¼ˆå»ºè®®æ¯å­£åº¦ï¼‰
3. âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
4. âœ… ä¸è¦å°† API Key æäº¤åˆ°ä»£ç ä»“åº“
5. âœ… åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶

### æ•°æ®åŠ å¯†

- API Secret Key å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼ˆæœªåŠ å¯†ï¼‰
- å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯¹æ•æ„Ÿå­—æ®µè¿›è¡ŒåŠ å¯†
- ä½¿ç”¨ HTTPS åè®®ä¿æŠ¤ API é€šä¿¡

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æŸ¥çœ‹åç«¯æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f backend/logs/app.log

# æœç´¢ EMQX ç›¸å…³æ—¥å¿—
grep "EMQX" backend/logs/app.log

# æœç´¢å®¢æˆ·ç«¯çŠ¶æ€æ—¥å¿—
grep "å®¢æˆ·ç«¯" backend/logs/app.log
```

### æ—¥å¿—ç¤ºä¾‹

**æˆåŠŸè·å–å®¢æˆ·ç«¯çŠ¶æ€ï¼š**
```
INFO: æ­£åœ¨è°ƒç”¨ EMQX API: http://172.16.208.176:18083/api/v5/clients
INFO: âœ… æˆåŠŸè·å– EMQX å®¢æˆ·ç«¯åˆ—è¡¨ï¼Œå…± 5 ä¸ªå®¢æˆ·ç«¯
```

**è®¤è¯å¤±è´¥ï¼š**
```
ERROR: âŒ EMQX API è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key å’Œ Secret Key æ˜¯å¦æ­£ç¡®
```

**è¿æ¥å¤±è´¥ï¼š**
```
ERROR: âŒ æ— æ³•è¿æ¥åˆ° EMQX APIï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç«¯å£
```

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æµ‹è¯•1: åŸºç¡€åŠŸèƒ½æµ‹è¯•

```bash
# 1. å¯åŠ¨ MQTT æµ‹è¯•å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨ mosquitto_pubï¼‰
mosquitto_pub -h 172.16.208.176 -p 1883 \
  -i device_001 \
  -u testuser \
  -P testpass \
  -t "test/topic" \
  -m "hello" \
  -d

# 2. åœ¨ Dashboard ä¸­åº”è¯¥çœ‹åˆ°è®¾å¤‡ device_001 æ˜¾ç¤ºä¸ºåœ¨çº¿

# 3. æ–­å¼€å®¢æˆ·ç«¯ (Ctrl+C)

# 4. ç­‰å¾…5ç§’åï¼Œè®¾å¤‡åº”è¯¥æ˜¾ç¤ºä¸ºç¦»çº¿
```

### æµ‹è¯•2: API è¿æ¥æµ‹è¯•

```bash
# ä½¿ç”¨ curl æµ‹è¯• EMQX API
curl -u f3d064c3dacad617:ezGnurOe8d4GV2LJF4Ptw46wnavTqL9AenBZyIoePWwP \
  http://172.16.208.176:18083/api/v5/clients \
  | jq .

# æœŸæœ›è¾“å‡ºï¼šå®¢æˆ·ç«¯åˆ—è¡¨çš„ JSON æ•°æ®
```

### æµ‹è¯•3: å‰ç«¯ API æµ‹è¯•

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ï¼š

```javascript
// è·å–å®¢æˆ·ç«¯çŠ¶æ€
fetch('/api/mqtt-publish/clients', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(data => console.log(data))
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ ç¼“å­˜æœºåˆ¶

```python
# åœ¨ mqtt_service.py ä¸­æ·»åŠ ç¼“å­˜
from functools import lru_cache
from datetime import datetime, timedelta

class MQTTService:
    def __init__(self):
        self._client_cache = None
        self._cache_time = None
        self._cache_ttl = 3  # 3ç§’ç¼“å­˜
    
    def get_emqx_clients(self):
        now = datetime.now()
        if self._client_cache and self._cache_time:
            if (now - self._cache_time).total_seconds() < self._cache_ttl:
                return self._client_cache
        
        # è°ƒç”¨ API
        data = self._fetch_from_api()
        self._client_cache = data
        self._cache_time = now
        return data
```

### 2. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

å½“è®¾å¤‡æ•°é‡å¾ˆå¤šæ—¶ï¼Œå¯ä»¥è°ƒæ•´ EMQX API çš„æŸ¥è¯¢å‚æ•°ï¼š

```python
params = {
    'limit': 10000,  # å¢åŠ é™åˆ¶
    'page': 1        # åˆ†é¡µæŸ¥è¯¢
}
```

### 3. å‰ç«¯é˜²æŠ–å¤„ç†

åœ¨ Dashboard.vue ä¸­æ·»åŠ é˜²æŠ–ï¼š

```javascript
import { debounce } from 'lodash'

const debouncedFetch = debounce(fetchDevicesWithSensors, 1000)
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [EMQX v5.2 REST API æ–‡æ¡£](https://docs.emqx.com/zh/emqx/v5.2/admin/api-docs.html)
- [EMQX API è®¤è¯è¯´æ˜](https://docs.emqx.com/zh/emqx/v5.2/admin/api.html)
- [è·å–å®¢æˆ·ç«¯åˆ—è¡¨ API](https://docs.emqx.com/zh/emqx/v5.2/admin/api-docs.html#tag/Clients/paths/~1clients/get)

## â“ å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆéœ€è¦é…ç½® API Keyï¼Ÿ

A: EMQX v5.0 ä¹‹åï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒDashboard ç”¨æˆ·æ— æ³•ç›´æ¥ç”¨äº REST API è®¤è¯ï¼Œå¿…é¡»åˆ›å»ºä¸“é—¨çš„ API Keyã€‚

### Q2: API Key å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

A: API Key å’Œ Secret Key å­˜å‚¨åœ¨ SQLite æ•°æ®åº“çš„ `mqtt_configs` è¡¨ä¸­ï¼Œä¸æ¿€æ´»çš„ MQTT é…ç½®å…³è”ã€‚

### Q3: å¦‚ä½•æ›´æ–° API Keyï¼Ÿ

A: æœ‰ä¸¤ç§æ–¹å¼ï¼š
1. åœ¨å‰ç«¯"EMQX APIé…ç½®"é¡µé¢æ›´æ–°
2. ç›´æ¥ä¿®æ”¹ `setup_emqx_api_key.py` è„šæœ¬å¹¶è¿è¡Œ

### Q4: è®¾å¤‡åœ¨çº¿çŠ¶æ€å¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Ÿ

A: Dashboard é¡µé¢æ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ã€‚æ‚¨å¯ä»¥åœ¨ `Dashboard.vue` ä¸­ä¿®æ”¹åˆ·æ–°é—´éš”ï¼š

```javascript
refreshInterval = setInterval(fetchDevicesWithSensors, 5000)  // 5000æ¯«ç§’ = 5ç§’
```

### Q5: ä¸ºä»€ä¹ˆæœ‰çš„è®¾å¤‡æ˜æ˜åœ¨çº¿å´æ˜¾ç¤ºç¦»çº¿ï¼Ÿ

A: è¯·æ£€æŸ¥ï¼š
1. è®¾å¤‡çš„ MQTT ClientID æ˜¯å¦ä¸ç³»ç»Ÿä¸­çš„è®¾å¤‡ ID æˆ–åç§°åŒ¹é…
2. è®¾å¤‡æ˜¯å¦çœŸçš„è¿æ¥åˆ°äº† EMQX æœåŠ¡å™¨
3. åœ¨ EMQX Dashboard ä¸­æŸ¥çœ‹å®¢æˆ·ç«¯åˆ—è¡¨è¿›è¡Œç¡®è®¤

### Q6: å¯ä»¥åŒæ—¶é…ç½®å¤šä¸ª EMQX æœåŠ¡å™¨çš„ API Key å—ï¼Ÿ

A: å½“å‰ç‰ˆæœ¬åªæ”¯æŒä¸ºæ¿€æ´»çš„ MQTT é…ç½®è®¾ç½® API Keyã€‚å¦‚æœæœ‰å¤šä¸ª MQTT é…ç½®ï¼Œåˆ‡æ¢æ¿€æ´»é…ç½®åéœ€è¦é‡æ–°é…ç½®å¯¹åº”çš„ API Keyã€‚

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.0.0 (2026-01-19)

**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… Dashboard ç»Ÿè®¡å¡ç‰‡ï¼ˆæ€»è®¾å¤‡æ•°ã€åœ¨çº¿è®¾å¤‡æ•°ã€ç¦»çº¿è®¾å¤‡æ•°ï¼‰
- âœ… è®¾å¤‡çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆç»¿è‰²/çº¢è‰²åœ†ç‚¹ï¼‰
- âœ… EMQX API é…ç½®ç®¡ç†é¡µé¢
- âœ… è‡ªåŠ¨åˆ·æ–°è®¾å¤‡çŠ¶æ€ï¼ˆ5ç§’é—´éš”ï¼‰
- âœ… API Key é…ç½®å’Œæµ‹è¯•åŠŸèƒ½

**æ•°æ®åº“å˜æ›´ï¼š**
- âœ… mqtt_configs è¡¨æ–°å¢ api_portã€api_keyã€api_secret å­—æ®µ

**ä¾èµ–æ›´æ–°ï¼š**
- âœ… æ·»åŠ  requests==2.31.0

## ğŸ’¡ æœªæ¥æ”¹è¿›å»ºè®®

1. **è®¾å¤‡ä¸Šçº¿/ä¸‹çº¿å†å²è®°å½•**
   - è®°å½•è®¾å¤‡çš„è¿æ¥å’Œæ–­å¼€æ—¶é—´
   - ç»Ÿè®¡è®¾å¤‡åœ¨çº¿æ—¶é•¿
   - ç”Ÿæˆåœ¨çº¿ç‡æŠ¥è¡¨

2. **å®æ—¶é€šçŸ¥**
   - è®¾å¤‡ç¦»çº¿æ—¶å‘é€å‘Šè­¦é€šçŸ¥
   - æ”¯æŒé‚®ä»¶ã€çŸ­ä¿¡ã€Webhook é€šçŸ¥

3. **æ‰¹é‡æ“ä½œ**
   - ç­›é€‰åœ¨çº¿/ç¦»çº¿è®¾å¤‡
   - æ‰¹é‡ç®¡ç†è®¾å¤‡

4. **è¿æ¥è´¨é‡ç›‘æ§**
   - æ˜¾ç¤ºè®¾å¤‡è¿æ¥çš„ IP åœ°å€
   - æ˜¾ç¤ºè®¾å¤‡æœ€åä¸Šçº¿æ—¶é—´
   - æ˜¾ç¤ºè®¾å¤‡æ¶ˆæ¯ç»Ÿè®¡

5. **å¤š MQTT æœåŠ¡å™¨æ”¯æŒ**
   - æ”¯æŒåŒæ—¶é…ç½®å¤šä¸ª EMQX æœåŠ¡å™¨çš„ API Key
   - è‡ªåŠ¨åˆ‡æ¢ä½¿ç”¨å¯¹åº”çš„ API é…ç½®

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼š

1. ğŸ“– æŸ¥çœ‹æ–‡æ¡£ï¼š
   - DEVICE_ONLINE_STATUS_FEATURE.md
   - EMQX_API_CONFIG.md

2. ğŸ” æ£€æŸ¥æ—¥å¿—ï¼š
   - åç«¯æ—¥å¿—: `backend/logs/app.log`
   - æµè§ˆå™¨æ§åˆ¶å°

3. ğŸ§ª æ‰‹åŠ¨æµ‹è¯•ï¼š
   - ä½¿ç”¨ curl æµ‹è¯• EMQX API
   - ä½¿ç”¨ mosquitto å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥

## âœ¨ æ€»ç»“

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸé…ç½®äº†è®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€åŠŸèƒ½ï¼š

âœ… æ•°æ®åº“è¿ç§»å®Œæˆ  
âœ… API Key å·²é…ç½®  
âœ… å‰ç«¯é¡µé¢å·²åˆ›å»º  
âœ… åç«¯ API å·²å®ç°  
âœ… èœå•å¯¼èˆªå·²æ·»åŠ   

ç°åœ¨æ‚¨å¯ä»¥ï¼š
1. å¯åŠ¨ç³»ç»ŸæŸ¥çœ‹æ•ˆæœ
2. åœ¨ Dashboard é¦–é¡µæŸ¥çœ‹è®¾å¤‡åœ¨çº¿çŠ¶æ€
3. åœ¨ EMQX API é…ç½®é¡µé¢ç®¡ç†å¯†é’¥
4. äº«å—å®æ—¶çš„è®¾å¤‡çŠ¶æ€ç›‘æ§ï¼

ç¥ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰
