# 实时数据页面历史数据改进方案

## 需求分析

用户希望：
1. **保留历史数据功能**
2. **按时间维度查看**：日、周、月
3. **优化温湿度图表展示**（分开显示或改进）

## 当前问题

1. **历史数据累积**：前端只保存最近20个点，无法查看更长时间范围
2. **温湿度混合图表**：量纲不同，难以比较
3. **缺少时间维度选择**：无法按日/周/月查看历史数据
4. **后端API限制**：没有按时间范围查询的接口

## 改进方案

### 一、后端：添加时间范围查询API

#### 1. 新增服务方法

**文件**: `backend/services/sensor_service.py`

```python
def get_device_sensors_by_time_range(
    db: Session, 
    device_id: int,
    sensor_type: Optional[str] = None,
    start_time: Optional[datetime] = None,
    end_time: Optional[datetime] = None,
    limit: Optional[int] = None
) -> List[SensorDataModel]:
    """根据时间范围获取设备的传感器数据"""
    query = db.query(SensorDataModel).filter(
        SensorDataModel.device_id == device_id
    )
    
    if sensor_type:
        query = query.filter(SensorDataModel.type == sensor_type)
    
    if start_time:
        query = query.filter(SensorDataModel.timestamp >= start_time)
    
    if end_time:
        query = query.filter(SensorDataModel.timestamp <= end_time)
    
    query = query.order_by(desc(SensorDataModel.timestamp))
    
    if limit:
        query = query.limit(limit)
    
    return query.all()
```

#### 2. 新增API端点

**文件**: `backend/api/sensors.py`

```python
@router.get("/device/{device_id}/history", response_model=List[SensorData])
def get_device_sensor_history(
    device_id: int,
    sensor_type: Optional[str] = None,
    start_time: Optional[str] = None,  # ISO格式时间字符串
    end_time: Optional[str] = None,
    time_range: Optional[str] = None,  # "day", "week", "month"
    limit: Optional[int] = None,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """获取设备的历史传感器数据（按时间范围）
    
    Args:
        device_id: 设备ID
        sensor_type: 传感器类型（可选）
        start_time: 开始时间（ISO格式，可选）
        end_time: 结束时间（ISO格式，可选）
        time_range: 时间范围（"day"/"week"/"month"），如果提供则自动计算start_time和end_time
        limit: 限制返回数量（可选）
    """
    from datetime import datetime, timedelta
    
    # 如果提供了time_range，自动计算时间范围
    if time_range:
        now = datetime.utcnow()
        if time_range == "day":
            start_time = now - timedelta(days=1)
            end_time = now
        elif time_range == "week":
            start_time = now - timedelta(weeks=1)
            end_time = now
        elif time_range == "month":
            start_time = now - timedelta(days=30)
            end_time = now
        else:
            raise HTTPException(status_code=400, detail="Invalid time_range. Use 'day', 'week', or 'month'")
    else:
        # 解析ISO格式时间字符串
        start_time = datetime.fromisoformat(start_time) if start_time else None
        end_time = datetime.fromisoformat(end_time) if end_time else None
    
    sensors = sensor_service_module.get_device_sensors_by_time_range(
        db, device_id, sensor_type, start_time, end_time, limit
    )
    return sensors
```

### 二、前端：添加时间维度选择和历史数据展示

#### 1. 添加时间维度选择器

**位置**: 设备选择卡片下方，图表区域上方

```vue
<!-- 时间维度选择器 -->
<div class="time-range-selector card shadow-sm mb-4">
  <div class="card-body p-3">
    <div class="d-flex align-items-center justify-content-between">
      <label class="mb-0 me-3">查看历史数据：</label>
      <div class="btn-group" role="group">
        <button 
          type="button" 
          class="btn btn-outline-primary"
          :class="{ 'active': timeRange === 'realtime' }"
          @click="setTimeRange('realtime')"
        >
          <i class="fas fa-clock me-1"></i>实时
        </button>
        <button 
          type="button" 
          class="btn btn-outline-primary"
          :class="{ 'active': timeRange === 'day' }"
          @click="setTimeRange('day')"
        >
          <i class="fas fa-calendar-day me-1"></i>日
        </button>
        <button 
          type="button" 
          class="btn btn-outline-primary"
          :class="{ 'active': timeRange === 'week' }"
          @click="setTimeRange('week')"
        >
          <i class="fas fa-calendar-week me-1"></i>周
        </button>
        <button 
          type="button" 
          class="btn btn-outline-primary"
          :class="{ 'active': timeRange === 'month' }"
          @click="setTimeRange('month')"
        >
          <i class="fas fa-calendar-alt me-1"></i>月
        </button>
      </div>
    </div>
  </div>
</div>
```

#### 2. 优化图表展示

**方案A：温湿度分开显示（推荐）**

```vue
<!-- 温度趋势图 -->
<div class="col-xl-6 col-md-12">
  <div class="chart-container">
    <h6>温度趋势</h6>
    <div ref="tempChartRef" class="chart-wrapper"></div>
  </div>
</div>

<!-- 湿度趋势图 -->
<div class="col-xl-6 col-md-12">
  <div class="chart-container">
    <h6>湿度趋势</h6>
    <div ref="humChartRef" class="chart-wrapper"></div>
  </div>
</div>
```

**方案B：改进双Y轴图表**

- Y轴范围自适应（基于数据范围）
- 添加数据点标记
- 优化图例和工具提示

#### 3. 数据获取逻辑

```javascript
// 时间范围选择
const timeRange = ref('realtime')  // 'realtime' | 'day' | 'week' | 'month'

// 设置时间范围
const setTimeRange = (range) => {
  timeRange.value = range
  if (range === 'realtime') {
    // 实时模式：每3秒轮询最新数据
    startRealtimeMode()
  } else {
    // 历史模式：加载指定时间范围的数据
    loadHistoryData(range)
  }
}

// 加载历史数据
const loadHistoryData = async (range) => {
  if (!selectedDeviceId.value) return
  
  try {
    loadingData.value = true
    
    // 调用历史数据API
    const response = await axios.get(`/api/sensors/device/${selectedDeviceId.value}/history`, {
      params: {
        time_range: range,
        limit: range === 'day' ? 288 : range === 'week' ? 168 : 720  // 按小时采样
      }
    })
    
    // 处理历史数据
    processHistoryData(response.data, range)
    
    // 更新图表
    updateHistoryCharts()
  } catch (error) {
    console.error('加载历史数据失败:', error)
    error.value = '加载历史数据失败'
  } finally {
    loadingData.value = false
  }
}

// 处理历史数据
const processHistoryData = (sensors, range) => {
  // 按传感器类型分组
  const dataByType = {}
  sensors.forEach(sensor => {
    if (!dataByType[sensor.type]) {
      dataByType[sensor.type] = []
    }
    dataByType[sensor.type].push({
      time: new Date(sensor.timestamp),
      value: sensor.value
    })
  })
  
  // 根据时间范围进行数据采样
  // 日：每小时一个点
  // 周：每4小时一个点
  // 月：每天一个点
  const sampledData = sampleDataByRange(dataByType, range)
  
  // 更新图表数据
  updateChartData(sampledData)
}
```

#### 4. 数据采样策略

```javascript
// 数据采样函数
const sampleDataByRange = (dataByType, range) => {
  const sampled = {}
  
  Object.keys(dataByType).forEach(type => {
    const data = dataByType[type]
    
    if (range === 'day') {
      // 日：每小时一个点（24个点）
      sampled[type] = sampleByHour(data)
    } else if (range === 'week') {
      // 周：每4小时一个点（42个点）
      sampled[type] = sampleByInterval(data, 4 * 60 * 60 * 1000)
    } else if (range === 'month') {
      // 月：每天一个点（30个点）
      sampled[type] = sampleByDay(data)
    }
  })
  
  return sampled
}
```

### 三、图表优化

#### 1. 温湿度分开显示

**温度图表**：
- 单Y轴：0-50°C（或自适应）
- 显示：Temperature1, Temperature2
- 颜色：红色系渐变

**湿度图表**：
- 单Y轴：0-100%（或自适应）
- 显示：Humidity1, Humidity2
- 颜色：蓝色系渐变

#### 2. X轴时间格式

```javascript
// 根据时间范围调整X轴格式
const getXAxisFormat = (range) => {
  if (range === 'day') {
    return 'HH:mm'  // 小时:分钟
  } else if (range === 'week') {
    return 'MM-DD HH:mm'  // 月-日 小时:分钟
  } else if (range === 'month') {
    return 'MM-DD'  // 月-日
  }
  return 'HH:mm:ss'  // 实时模式
}
```

#### 3. 数据点密度控制

- **实时模式**：显示最近20个点（每3秒一个）
- **日模式**：显示24个点（每小时一个）
- **周模式**：显示42个点（每4小时一个）
- **月模式**：显示30个点（每天一个）

## 实施步骤

### 阶段一：后端API开发
1. ✅ 添加 `get_device_sensors_by_time_range` 服务方法
2. ✅ 添加 `/api/sensors/device/{device_id}/history` API端点
3. ✅ 测试API功能

### 阶段二：前端基础功能
1. ✅ 添加时间维度选择器UI
2. ✅ 实现时间范围切换逻辑
3. ✅ 实现历史数据加载函数

### 阶段三：图表优化
1. ✅ 将温湿度图表分开显示
2. ✅ 实现数据采样逻辑
3. ✅ 优化X轴时间格式
4. ✅ 优化Y轴范围（自适应）

### 阶段四：用户体验优化
1. ✅ 添加加载状态提示
2. ✅ 添加数据为空提示
3. ✅ 添加时间范围显示
4. ✅ 响应式布局优化

## 技术要点

### 1. 数据采样策略
- **目的**：减少数据点数量，提高图表性能
- **方法**：按时间间隔采样或按平均值采样

### 2. 时间范围计算
```javascript
// 计算时间范围
const getTimeRange = (range) => {
  const now = new Date()
  switch(range) {
    case 'day':
      return { start: new Date(now - 24*60*60*1000), end: now }
    case 'week':
      return { start: new Date(now - 7*24*60*60*1000), end: now }
    case 'month':
      return { start: new Date(now - 30*24*60*60*1000), end: now }
    default:
      return null
  }
}
```

### 3. 性能优化
- 数据采样减少数据点
- 图表懒加载
- 防抖处理（切换时间范围时）

## 预期效果

1. ✅ 用户可以选择查看实时/日/周/月数据
2. ✅ 温湿度分开显示，更清晰
3. ✅ 历史数据按时间范围正确显示
4. ✅ 图表性能良好，响应快速
5. ✅ 用户体验流畅
