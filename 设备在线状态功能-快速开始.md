# 设备在线/离线状态功能 - 快速开始

## 功能概述

Dashboard 首页现在可以实时显示设备的在线/离线状态，包括：

✅ **统计卡片**：显示总设备数、在线设备数、离线设备数  
✅ **状态指示器**：每个设备卡片显示绿色/红色状态圆点  
✅ **自动刷新**：每 5 秒自动更新状态  

## 快速启动

### 1. 安装依赖

```bash
# 后端
cd backend
pip install -r requirements.txt

# 前端（如果是新环境）
cd frontend
npm install
```

### 2. 配置 EMQX API（可选）

如果 EMQX 使用默认配置（admin/public），无需修改。

如果需要自定义认证，编辑 `backend/services/mqtt_service.py`：

```python
# 在 get_emqx_clients() 方法中找到这两行：
api_username = getattr(mqtt_config, 'api_username', 'admin')    # 修改用户名
api_password = getattr(mqtt_config, 'api_password', 'public')  # 修改密码
```

### 3. 启动服务

```bash
# 启动后端（在backend目录）
python main.py

# 启动前端（在frontend目录）
npm run dev
```

### 4. 访问 Dashboard

打开浏览器访问：http://localhost:5173

## 预期效果

### 统计卡片（顶部）

```
┌─────────────────┬─────────────────┬─────────────────┐
│   总设备数      │   在线设备      │   离线设备      │
│      10        │      7         │      3         │
│    (紫色)      │    (绿色)      │    (红色)      │
└─────────────────┴─────────────────┴─────────────────┘
```

### 设备卡片状态指示器

```
┌──────────────────────────────┐
│ ⚫ 设备名称           [图标] │  <- 绿色圆点 = 在线
│ 温度: 25.0°C               │     红色圆点 = 离线
│ 湿度: 60.0%                │
└──────────────────────────────┘
```

## 故障排查

### 所有设备显示离线

**检查清单：**

1. ✅ EMQX 服务是否运行
   ```bash
   # 检查 EMQX 状态
   systemctl status emqx
   # 或
   docker ps | grep emqx
   ```

2. ✅ EMQX API 是否可访问
   ```bash
   curl -u admin:public http://localhost:18083/api/v5/clients
   ```

3. ✅ 设备 ClientID 是否匹配
   - 设备的 ID 或 name 字段需要与 MQTT 客户端的 ClientID 一致

### 后端日志查看

```bash
# 查看后端日志
tail -f backend/logs/app.log

# 搜索相关错误
grep "EMQX" backend/logs/app.log
grep "客户端状态" backend/logs/app.log
```

## 技术细节

### API 端点

**前端调用：**
```javascript
GET /api/mqtt-publish/clients
```

**后端转发：**
```
GET http://{emqx_server}:18083/api/v5/clients
认证: Basic admin:public
```

### 状态匹配逻辑

```javascript
// 设备在线判断
const isOnline = 
  onlineClientIds.has(device.id) ||    // 匹配设备ID
  onlineClientIds.has(device.name)     // 或匹配设备名称
```

## 配置文件

- `backend/services/mqtt_service.py` - MQTT 服务和 EMQX API 调用
- `backend/api/mqtt_publish.py` - API 端点定义
- `frontend/src/views/Dashboard.vue` - 前端界面和逻辑

## 详细文档

- [完整功能说明](./DEVICE_ONLINE_STATUS_FEATURE.md)
- [EMQX API 配置](./EMQX_API_CONFIG.md)
- [EMQX 官方文档](https://docs.emqx.com/zh/emqx/v5.2/admin/api-docs.html)

## 常见问题

**Q: 为什么有的设备显示在线，有的显示离线？**  
A: 检查设备的 MQTT 客户端是否正常连接，以及 ClientID 是否与系统中的设备 ID/名称匹配。

**Q: 状态更新有延迟？**  
A: 系统每 5 秒刷新一次。如需调整频率，修改 `Dashboard.vue` 中的 `refreshInterval`。

**Q: 如何查看 EMQX 中的客户端列表？**  
A: 访问 EMQX Dashboard：http://localhost:18083 或使用 API：
```bash
curl -u admin:public http://localhost:18083/api/v5/clients | jq
```

## 技术支持

如遇问题：

1. 查看后端日志：`backend/logs/app.log`
2. 查看浏览器控制台错误
3. 检查 EMQX 服务状态和日志
4. 参考详细文档：`DEVICE_ONLINE_STATUS_FEATURE.md`
